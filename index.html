<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"samlin-msft.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0RM9XRL718"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0RM9XRL718');
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="雜七雜八。有的沒的">
<meta property="og:url" content="https://samlin-msft.github.io/index.html">
<meta property="og:site_name" content="雜七雜八。有的沒的">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Sam Lin">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://samlin-msft.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>雜七雜八。有的沒的</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0RM9XRL718"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-0RM9XRL718');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">雜七雜八。有的沒的</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://samlin-msft.github.io/2021/10/22/locking-down-an-app-service-zhtw/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avator.png">
      <meta itemprop="name" content="Sam Lin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雜七雜八。有的沒的">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/22/locking-down-an-app-service-zhtw/" class="post-title-link" itemprop="url">App Service outbound 流量控管</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-10-22 01:16:27" itemprop="dateCreated datePublished" datetime="2021-10-22T01:16:27+08:00">2021-10-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-10-24 23:05:16" itemprop="dateModified" datetime="2021-10-24T23:05:16+08:00">2021-10-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/App-Service/" itemprop="url" rel="index"><span itemprop="name">App Service</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Azure App Service 網路流量控管強化分為兩方面，分別為 inbound 流量與 outbound 流量。Inbound 是使用者存取你的 App Service 流量, outbound 則是你的 App Service 存取其他網路資源的流量。有關 inbound 的網路概念與安全強化, 可以參考 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/app-service/networking-features">Networking features - Azure App Service</a> 以及 <a target="_blank" rel="noopener" href="https://azure.github.io/AppService/2020/08/14/zero_to_hero_pt6.html">Zero to Hero with App Service, Part 6: Securing your web app - Azure App Service</a> 。 多數企業希望能夠控管 App Service 對外存取網路的流量, 以防止不當的網路資源存取, 造成資料外洩或是惡意程式的植入風險，本篇文件將以 Multi-tenant App Service outbound 流量控管有關的網路功能做介紹如下，此外還有兩種特定用途的 App Service outbound 有關網路功能, 如 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/app-service/app-service-hybrid-connections">Hybrid connections</a> 以及 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/app-service/overview-vnet-integration#gateway-required-vnet-integration">Gateway-required VNet Integration</a>, 將不在此文件中介紹。</p>
<ul>
<li>虛擬網路整合 (Regional VNet integration)</li>
<li>整合 Azure Firewall 與路由表 (Route table/UDR) 流量控管</li>
<li><code>vnetRouteAllEnabled</code> 屬性或 <code>WEBSITE_VNET_ROUTE_ALL</code> 網站設定</li>
<li>服務端點 (Service endpoints)</li>
</ul>
<h2 id="區域虛擬網路整合-Regional-VNet-integration"><a href="#區域虛擬網路整合-Regional-VNet-integration" class="headerlink" title="區域虛擬網路整合 (Regional VNet integration)"></a>區域虛擬網路整合 (Regional VNet integration)</h2><p>虛擬網路整合功能並非 inbound 存取限制, 而是讓 App Service 從虛擬網路存取資源。Apps Service 運行在工作角色 (worker roles) 上，啟用區域虛擬網路整合時，將會在工作角色上掛載一個網路介面到專用的子網路上，配置後會從虛擬網路上配置 IP 地址給網路介面，存取方式類似虛擬機上的網卡運作在虛擬網路上，但實作上因為跟 VM 仍有些許不同，因此不是所有功能都跟虛擬機上的網路功能一致。</p>
<p>當啟用區域虛擬網路整合功能後，App Service 預先配置的對外 IP 地址仍會繼續運作，但如果您存取的資源是私有端點 (private endpoint) 或對等虛擬網路 (peered VNet) 時，此時 outbound IP 地址則會使用從整合的虛擬網路配置一個私有 IP 地址，這個地址將會存在環境變數 <code>WEBSITE_PRIVATE_IP</code> 中。同時若有網路安全群組 (network security group) 關連到這個專用的子網路上，outbound 連線規則將會在這個區域虛擬網路整合 outbound 連線作用。</p>
<h3 id="設定區域虛擬網路整合"><a href="#設定區域虛擬網路整合" class="headerlink" title="設定區域虛擬網路整合"></a>設定區域虛擬網路整合</h3><p>設定區域虛擬網路整合，您必須要有專用的子網路，此功能需要是 Premium V2 或 Premium V3 擴展單元 App Service Plan，部分較新的 Standard 擴展單元 App Service Plan 也可以設定區域虛擬網路整合功能。</p>
<ul>
<li><p>Subnet 需求 - 設定區域虛擬網路整合，您必須要有專用的子網路，建議子網路大小至少為 <code>/28</code> 以上，一旦設定後要更改只能先關閉區域虛擬網路整合功能才能重新設定。</p>
</li>
<li><p>設定區域虛擬網路整合 - </p>
<p>(1) 從 Azure Portal 網站中選取 <strong>App Service</strong> &gt; <strong>Networking</strong> &gt; <strong>VNet integration</strong> 啟用區域虛擬網路整合</p>
</li>
</ul>
<p><img src="/2021/10/22/locking-down-an-app-service-zhtw/image-20211024111248543.png" alt="image-20211024111248543"></p>
<p>​        (2) 選取 <strong>+ Add VNet</strong> &gt; 選取 <strong>Subscription</strong> &gt; 選取與 App Service 相同區域的 <strong>Virtual Network</strong> &gt; <strong>Select Existing</strong> &gt; 選取現有的 <strong>Subnet</strong></p>
<p><img src="/2021/10/22/locking-down-an-app-service-zhtw/image-20211024111829054.png" alt="image-20211024111829054"></p>
<p>​        (3) 設定完成後，預設設定如下：</p>
<p><img src="/2021/10/22/locking-down-an-app-service-zhtw/image-20211024112205239.png" alt="image-20211024112205239"></p>
<h2 id="整合-Azure-Firewall-與路由表-Route-Table-UDR"><a href="#整合-Azure-Firewall-與路由表-Route-Table-UDR" class="headerlink" title="整合 Azure Firewall 與路由表 (Route Table/UDR)"></a>整合 Azure Firewall 與路由表 (Route Table/UDR)</h2><p><strong>Azure Firewall</strong> 是一個用以保護 Azure 雲端資源的可以自動擴展以及高可用性的網路安全服務。在 Azure Firewall 中，您可建立應用程式與網路連線原則以控管網路流量，提供偵測與保護的功能。關於 Azure Firewall 的功能可以參考 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/firewall/features">Azure Firewall features</a>。</p>
<p>Azure <strong>路由表</strong>是 Azure 虛擬網路個子網路的流量流向的一個對照表。Azure 網路預設會有一個系統路由，在服務建立時會自動加入包含網路位址前綴以及下一個跳躍點 (next hop) 紀錄。關於系統路由的資訊可以參考 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-udr-overview#default">Azure virtual network traffic routing</a>。</p>
<p>您可以透過創建自定義的路由表 (<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-udr-overview#user-defined">user-defined</a> routes/UDR) 控制網路流向的對照表，常見的使用情境是藉由新增特定的網路位址前綴所對應的下一個跳躍點到網路設備如 Azure Firewall 以控管網路流量。</p>
<p>本範例以自定義路由表與 Azure Firewall 整合來控管 App Service outbound 流量。</p>
<h3 id="設定-Azure-Firewall"><a href="#設定-Azure-Firewall" class="headerlink" title="設定 Azure Firewall"></a>設定 Azure Firewall</h3><p>您需要一個 Azure Firewall，如果需要建立一個新的 Azure Firewall，可以參考 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/firewall/tutorial-firewall-deploy-portal">Deploy &amp; configure Azure Firewall using the Azure portal</a>。</p>
<ul>
<li>取得 Azure Firewall 私有 IP 位址 - 您需要從新建或既有的 Azure Firewall 取得私有 IP 位址以便設定路由表的下一個跳躍點。</li>
</ul>
<p><img src="/2021/10/22/locking-down-an-app-service-zhtw/image-20211024201542112.png" alt="image-20211024201542112"></p>
<ul>
<li><p>設定防火牆原則 - 若要在 Azure Firewall 上控管 App Service outbound 流量，可以先取得 App Service 的私有 IP 位址以便在防火牆原則設定規則。</p>
<p>(1) App Service 的私有 IP 位址可以從 App Service Kudu 服務取得 <code>WEBSITE_PRIVATE_IP</code> 環境變數資訊。開啟瀏覽器，輸入 <code>https://appname.scm.azurewebsites.net</code> 可以進入 App Service Kudu 服務後台，點選 <strong>Environment</strong> 再找尋 <code>WEBSITE_PRIVATE_IP</code> 環境變數可以取得 App Service 的私有 IP 位址資訊。</p>
</li>
</ul>
<p><img src="/2021/10/22/locking-down-an-app-service-zhtw/image-20211024203020350.png" alt="image-20211024203020350"></p>
<p>​        (2) 設定網路規則 - 允許 App Service 通過 Azure Firewall 對外連線可以設定以下的網路規則。在 <strong>Azure Firewall Policy</strong> &gt; 選取 <strong>Network Rules</strong> &gt; 選取 <strong>+ Add a rule collection</strong> 新增一個允許 App Service 私有 IP 位址來源的網路規則如下：</p>
<p><img src="/2021/10/22/locking-down-an-app-service-zhtw/image-20211024205357250.png" alt="image-20211024205357250"></p>
<h3 id="設定路由表"><a href="#設定路由表" class="headerlink" title="設定路由表"></a>設定路由表</h3><p>Azure Firewall 規則建立後，您需要在 App Service 區域虛擬網路整合的子網路上關連到一個自定義的路由表 (UDR)，以便將 App outbound 流量指向到 Azure Firewall 上。</p>
<p>​        (1) 建立一個 <strong>路由表 (Route Table)</strong></p>
<p><img src="/2021/10/22/locking-down-an-app-service-zhtw/image-20211024211106577.png" alt="image-20211024211106577"></p>
<p>​        (2) 新增一筆 Route 規則將預設流量 (<strong>0.0.0.0/0</strong>) 前綴以及下一個跳躍點 (<strong>next hop</strong>) 指向 Azure Firewall 私有 IP 地址</p>
<p><img src="/2021/10/22/locking-down-an-app-service-zhtw/image-20211024213847265.png" alt="image-20211024213847265"></p>
<p><img src="/2021/10/22/locking-down-an-app-service-zhtw/image-20211024214049697.png" alt="image-20211024214049697"></p>
<p>​        (3) 將路由表關連到 App Service 設定區域虛擬網路的子網路上</p>
<p><img src="/2021/10/22/locking-down-an-app-service-zhtw/image-20211024214255296.png" alt="image-20211024214255296"></p>
<h2 id="vnetRouteAllEnabled-或-WEBSITE-VNET-ROUTE-ALL-網站設定"><a href="#vnetRouteAllEnabled-或-WEBSITE-VNET-ROUTE-ALL-網站設定" class="headerlink" title="vnetRouteAllEnabled 或 WEBSITE_VNET_ROUTE_ALL 網站設定"></a><code>vnetRouteAllEnabled</code> 或 <code>WEBSITE_VNET_ROUTE_ALL</code> 網站設定</h2><p>App Service 啟用區域虛擬網路整合時，預設會將 <code>vnetRouteAllEnabled</code> 屬性啟用，如下圖 (1)。在早期版本的 App Service 只有開放設定網站設定 <code>WEBSITE_VNET_ROUTE_ALL</code> = <code>1</code>，若您需要使用網站設定啟用，請參考下圖 (2)，或使用 az cli 設定範例如下。當這個屬性未設定時，App Service outbound 流量目的 IP 位址為 RFC1918 規範定義的私有 IP 位址以及區域虛擬網路整合的子網路上有設定為服務端點 (Service endpoints) 的流量才會送往虛擬網路，若將此屬性開啟時，則所有的 outbound 流量都會送往虛擬網路。</p>
<p>註：目前區域虛擬網路整合尚未支持 Port 25 的流量。</p>
<ul>
<li>圖 (1)</li>
</ul>
<p><img src="/2021/10/22/locking-down-an-app-service-zhtw/image-20211024214828917.png" alt="image-20211024214828917"></p>
<ul>
<li>圖 (2)</li>
</ul>
<p><img src="/2021/10/22/locking-down-an-app-service-zhtw/vnetint-appsetting.png" alt="image-vnetint-appsetting"></p>
<ul>
<li>az cli 設定</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az webapp config <span class="built_in">set</span> --resource-group myRG --name myWebApp --vnet-route-all-enabled [<span class="literal">true</span>|<span class="literal">false</span>]</span><br></pre></td></tr></table></figure>


<h2 id="App-Service-與服務端點-Service-Endpoints"><a href="#App-Service-與服務端點-Service-Endpoints" class="headerlink" title="App Service 與服務端點 (Service Endpoints)"></a>App Service 與服務端點 (Service Endpoints)</h2><p>App Service Outbound 存取到 Azure 服務的流量預設會跟存取 Internet 路由相同，若啟用區域虛擬網路整合功能，提供一種可以將存取 Azure 服務流量路由經由微軟雲端骨幹直接存取到 Azure 服務，這個設定是關連到區域虛擬網路整合中的子網路上設定服務端點 (Service Endpoints)，透過這個設定具有強化安全性以及最佳化 Azure 服務流量與易於設定管理的優點。關於服務端點資訊可以參考 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview">Azure virtual network service endpoints</a>。</p>
<h3 id="設定服務端點"><a href="#設定服務端點" class="headerlink" title="設定服務端點"></a>設定服務端點</h3><p>以下以區域虛擬網路整合中的子網路上設定 Storage 服務端點為範例。</p>
<p>開啟 App Service 整合的 <strong>虛擬網路</strong> &gt; 選取 <strong>Service endpoints</strong> &gt; <strong>+ Add</strong> &gt; 選取 <strong>Microsoft.Storage</strong> 服務 &gt; 選取 App Service 的<strong>子網路</strong></p>
<p><img src="/2021/10/22/locking-down-an-app-service-zhtw/image-20211024222801645.png" alt="image-20211024222801645"></p>
<h2 id="App-Service-outbound-流量控管"><a href="#App-Service-outbound-流量控管" class="headerlink" title="App Service outbound 流量控管"></a>App Service outbound 流量控管</h2><p>根據<strong>區域虛擬網路整合</strong>、<strong>vnetRouteAllEnabled</strong>、<strong>路由表</strong>和<strong>服務端點</strong>設定，在 App Service outbound 流量路徑例圖如下：</p>
<p><img src="/2021/10/22/locking-down-an-app-service-zhtw/image-20211023175706922.png" alt="image-20211023175706922"></p>
<p>整理設定組合與 Public IP 位址、Private IP 位址，以及 Azure 服務流量路徑列表如下:</p>
<table>
<thead>
<tr>
<th>#</th>
<th>WEBSITE_VNET_ROUTE_ALL</th>
<th>Regional VNet Integration Setting</th>
<th>Service Endpoints Setting</th>
<th>Public IP Address Traffic Path</th>
<th>Private IP Address Traffic Path</th>
<th>Azure Services (Ex: Storage) Traffic Path</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>1</td>
<td>X</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>null</td>
<td>Enabled</td>
<td>null</td>
<td>1</td>
<td>2</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>null</td>
<td>Enabled</td>
<td>Enabled</td>
<td>1</td>
<td>2</td>
<td>1</td>
</tr>
<tr>
<td>4</td>
<td>1</td>
<td>Enabled</td>
<td>null</td>
<td>2</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td>5</td>
<td>1</td>
<td>Enabled</td>
<td>Enabled</td>
<td>2</td>
<td>2</td>
<td>3</td>
</tr>
</tbody></table>
<ul>
<li><p><strong>App Service outbound 流量控管 - 預設</strong></p>
<ul>
<li>Public IP 位址流量路徑 - Outbound 流量會從 App Service 預設的 outbound IP 位址對外直接連線 (路徑 1)。</li>
<li>Private IP 位址流量路徑 - 未設定區域虛擬網路整合，因此 App Service outboud 流量不會經由 VNet。</li>
<li>Azure 服務流量路徑 - Outbound 流量會從 App Service 預設的 outbound IP 位址對外直接連線 (路徑 1)。</li>
</ul>
</li>
<li><p><strong>App Service outbound 流量控管 - 設定虛擬網路整合</strong></p>
<ul>
<li>Public IP 位址流量路徑 - Outbound 流量會從 App Service 預設的 outbound IP 位址對外直接連線 (路徑 1)。</li>
<li>Private IP 位址流量路徑 - 目的 IP 位址為 RFC1918 規範定義的私有 IP 位址， Outbound 流量會從 VNet 設定的 UDR 路由轉送到 Azure Firewall (路徑 2)。</li>
<li>Azure 服務流量路徑 - Outbound 流量會從 App Service 預設的 outbound IP 位址對外直接連線 (路徑 1)。</li>
</ul>
</li>
<li><p><strong>App Service outbound 流量控管 - 設定虛擬網路整合與服務端點</strong></p>
<ul>
<li>Public IP 位址流量路徑 - Outbound 流量會從 App Service 預設的 outbound IP 位址對外直接連線 (路徑 1)。</li>
<li>Private IP 位址流量路徑 - 目的 IP 位址為 RFC1918 規範定義的私有 IP 位址， Outbound 流量會從 VNet 設定的 UDR 路由轉送到 Azure Firewall (路徑 2)。</li>
<li>Azure 服務流量路徑 - Outbound 流量會從 App Service 預設的 outbound IP 位址對外直接連線 (路徑 1)。</li>
</ul>
</li>
<li><p><strong>App Service outbound 流量控管 - 設定 <code>vnetRouteAllEnabled</code> 屬性與虛擬網路整合</strong></p>
<ul>
<li>Public IP 位址流量路徑 - 啟用<code>vnetRouteAllEnabled</code> 屬性，Outbound 流量會從 VNet 設定的 UDR 路由轉送到 Azure Firewall (路徑 2)。</li>
<li>Private IP 位址流量路徑 - 目的 IP 位址為 RFC1918 規範定義的私有 IP 位址， Outbound 流量會從 VNet 設定的 UDR 路由轉送到 Azure Firewall (路徑 2)。</li>
<li>Azure 服務流量路徑 - 啟用<code>vnetRouteAllEnabled</code> 屬性， 存取 Azure Service 時，Outbound 流量會從 VNet 設定的 UDR 路由轉送到 Azure Firewall (路徑 2)。</li>
</ul>
</li>
<li><p><strong>App Service outbound 流量控管 - 設定 <code>vnetRouteAllEnabled</code> 屬性, 虛擬網路整合與服務端點</strong></p>
<ul>
<li>Public IP 位址流量路徑 -  啟用<code>vnetRouteAllEnabled</code> 屬性，Outbound 流量會從 VNet 設定的 UDR 路由轉送到 Azure Firewall (路徑 2)。</li>
<li>Private IP 位址流量路徑 - 目的 IP 位址為 RFC1918 規範定義的私有 IP 位址， Outbound 流量會從 VNet 設定的 UDR 路由轉送到 Azure Firewall (路徑 2)。</li>
<li>Azure 服務流量路徑 - 啟用<code>vnetRouteAllEnabled</code> 屬性與服務端點， 存取 Azure Service 時，Outbound 流量會從 VNet 設定的服務端點路由經由微軟網路骨幹存取 Azure 服務 (路徑 3)。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="參考"><a href="#參考" class="headerlink" title="參考"></a>參考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/app-service/networking-features">Networking features - Azure App Service</a></li>
<li><a target="_blank" rel="noopener" href="https://azure.github.io/AppService/2020/08/14/zero_to_hero_pt6.html">Zero to Hero with App Service, Part 6: Securing your web app - Azure App Service</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/app-service/app-service-hybrid-connections">Hybrid connections - Azure App Service</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/app-service/overview-vnet-integration">Integrate app with Azure virtual network - Azure App Service</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/MicrosoftDocs/azure-docs/blob/master/includes/app-service-web-vnet-regional.md">azure-docs/app-service-web-vnet-regional.md at master · MicrosoftDocs/azure-docs (github.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/firewall/tutorial-firewall-deploy-portal-policy">Tutorial: Deploy &amp; configure Azure Firewall and policy using the Azure portal</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/firewall/features">Azure Firewall features</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-udr-overview">Azure virtual network traffic routing</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/firewall/tutorial-firewall-deploy-portal">Deploy &amp; configure Azure Firewall using the Azure portal</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview">Azure virtual network service endpoints</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://samlin-msft.github.io/2021/10/12/integrate-ilb-asev3-with-application-gateway-en-us/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avator.png">
      <meta itemprop="name" content="Sam Lin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雜七雜八。有的沒的">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/12/integrate-ilb-asev3-with-application-gateway-en-us/" class="post-title-link" itemprop="url">Integrate ILB ASEv3 with Application Gateway</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-10-12 06:29:32" itemprop="dateCreated datePublished" datetime="2021-10-12T06:29:32+08:00">2021-10-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-10-14 00:36:22" itemprop="dateModified" datetime="2021-10-14T00:36:22+08:00">2021-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/App-Service-Environment/" itemprop="url" rel="index"><span itemprop="name">App Service Environment</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>The <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/app-service/environment/intro">Azure App Service Environment</a> is a deployment of Azure App Service in the subnet of a customer’s Azure virtual network. It can be deployed with a public or private endpoint for app access. The deployment of the App Service Environment with a private endpoint (that is, an internal load balancer) is called an ILB App Service Environment.</p>
<p>Web application firewalls help secure your web applications by inspecting inbound web traffic to block SQL injections, Cross-Site Scripting, malware uploads &amp; application DDoS and other attacks. You can get a WAF device from the Azure marketplace or you can use the <a target="_blank" rel="noopener" href="https://docs.microsoft.com/azure/application-gateway/overview">Azure Application Gateway</a>.</p>
<p>The Azure Application Gateway is a virtual appliance that provides layer 7 load balancing, TLS/SSL offloading, and web application firewall (WAF) protection. It can listen on a public IP address and route traffic to your application endpoint. The following information describes how to integrate a WAF-configured application gateway with an app in an ILB App Service Environment.  </p>
<p>The integration of the application gateway with the ILB App Service Environment is at an app level. When you configure the application gateway with your ILB App Service Environment, you’re doing it for specific apps in your ILB App Service Environment. This technique enables hosting secure multitenant applications in a single ILB App Service Environment.</p>
<p><img src="/2021/10/12/integrate-ilb-asev3-with-application-gateway-en-us/image-20211011152138347.png" alt="image-20211011152138347"></p>
<p>In this walkthrough, you will:</p>
<ul>
<li>Create an Azure Application Gateway.</li>
<li>Configure the Application Gateway to point to an app in your ILB App Service Environment.</li>
<li>Configure your app to honor the custom domain name.</li>
<li>Edit the public DNS host name that points to your application gateway.</li>
</ul>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><p>To integrate your Application Gateway with your ILB App Service Environment, you need:</p>
<ul>
<li>An ILB App Service Environment.</li>
<li>A private DNS zone for ILB App Service Environment.</li>
<li>An app running in the ILB App Service Environment.</li>
<li>A public DNS name that is used later to point to your Application Gateway.</li>
<li>A valid public certificate that is used later to bind to your Application Gateway.</li>
</ul>
<h3 id="ILB-App-Service-Environment"><a href="#ILB-App-Service-Environment" class="headerlink" title="ILB App Service Environment"></a>ILB App Service Environment</h3><p>For details on how to create an ILB App Service Environment from Azure portal, see <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/app-service/environment/creation">Create an App Service Environment</a> or create from template, see <a target="_blank" rel="noopener" href="https://docs.microsoft.com/azure/app-service/environment/create-from-template">Create an ASE with ARM - Azure App Service Environment</a></p>
<ul>
<li>After ILB ASE had been created, the default domain will be <code>&lt;YourAseName&gt;.appserviceenvironment.net</code> </li>
</ul>
<p><img src="/2021/10/12/integrate-ilb-asev3-with-application-gateway-en-us/image-20211011155312176.png" alt="image-20211011155312176"></p>
<ul>
<li>An internal load balancer had be provisioned for inbound access. You can check the Inbound address in the IP addresses under ASE Settings plane. You will need to create a private DNS zone mapped to this IP address later.</li>
</ul>
<p><img src="/2021/10/12/integrate-ilb-asev3-with-application-gateway-en-us/image-20211011160529160.png" alt="image-20211011160529160"></p>
<h3 id="Private-DNS-Zone"><a href="#Private-DNS-Zone" class="headerlink" title="Private DNS Zone"></a>Private DNS Zone</h3><p>You will need a private DNS zone for internal name resolution. If you didn’t configure private DNS zone while creating ASE, you have to create a private DNS zone after ASE created. To create a private DNS zone on Azure Portal, see <a target="_blank" rel="noopener" href="https://docs.microsoft.com/azure/dns/private-dns-getstarted-portal">Quickstart - Create an Azure private DNS zone using the Azure portal</a>, the record sets listed a below,</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Value</th>
</tr>
</thead>
<tbody><tr>
<td>*</td>
<td>A</td>
<td>ASE inbound address</td>
</tr>
<tr>
<td>@</td>
<td>A</td>
<td>ASE inbound address</td>
</tr>
<tr>
<td>@</td>
<td>SOA</td>
<td>ASE DNS name</td>
</tr>
<tr>
<td>*.scm</td>
<td>A</td>
<td>ASE inbound address</td>
</tr>
</tbody></table>
<p><img src="/2021/10/12/integrate-ilb-asev3-with-application-gateway-en-us/image-20211011155613716.png" alt="image-20211011155613716"></p>
<h3 id="App-Service-on-ILB-ASE"><a href="#App-Service-on-ILB-ASE" class="headerlink" title="App Service on ILB ASE"></a>App Service on ILB ASE</h3><p>You will need to create an app service and an app service plan reside in an ILB ASE. To create an app service in an ILB ASE on Azure Portal, in app creation <strong>Basics</strong> setting, you need to pick the ILB ASE you created previously in the <strong>Region</strong> dropdown list.</p>
<p><img src="/2021/10/12/integrate-ilb-asev3-with-application-gateway-en-us/image-20211011164224837.png" alt="image-20211011164224837"></p>
<h3 id="App-Service-DNS-name"><a href="#App-Service-DNS-name" class="headerlink" title="App Service DNS name"></a>App Service DNS name</h3><p>In order to connect to Application Gateway from internet, you need a routable domain name. In this case, I used a routable domain name <code>asabuludemo.com</code> and planning to connect to an app service with this domain name <code>app.asabuludemo.com</code>. The IP address mapped to this app domain name need to set to the public IP after Application Gateway created.</p>
<h3 id="A-valid-public-certificate"><a href="#A-valid-public-certificate" class="headerlink" title="A valid public certificate"></a>A valid public certificate</h3><p>For security enhancement, it is recommended to bind TLS/SSL certificate for session encryption. To bind TLS/SSL certificate to Application Gateway, you need a valid public certificate, the <strong>Common Name</strong> (<strong>CN</strong>) and <strong>Subject Alternative Name</strong> (<strong>SAN</strong>) of certificate should be below,</p>
<ul>
<li><strong>Common Name</strong>: <code>*.&lt;yourdomainname&gt;</code>, for example: <code>*.asabuludemo.com</code></li>
<li><strong>Subject Alternative Name</strong>: <code>*.scm.&lt;yourdomainname&gt;</code> for example: <code>*.scm.asabuludemo.com</code>. This <strong>SAN</strong> allow to connect to app service kudo service. This is an optional setting, if you don’t want to publish the app service kudo service to the internet. </li>
</ul>
<p>The certificate file must contains a private kay and save to .pfx format, it will be imported to Application Gateway later.</p>
<h2 id="Create-an-Application-Gateway"><a href="#Create-an-Application-Gateway" class="headerlink" title="Create an Application Gateway"></a>Create an Application Gateway</h2><p>Before you start to create the Application Gateway, pick or create a subnet that you will use to host the gateway.</p>
<p>You should use a subnet that is not the one named GatewaySubnet. If you put the Application Gateway in GatewaySubnet, you’ll be unable to create a virtual network gateway later.</p>
<p>You also cannot put the gateway in the subnet that your ILB App Service Environment uses. The App Service Environment is the only thing that can be in this subnet.</p>
<p>In this tutorial, we will use Azure Portal to create an Application Gateway.</p>
<h3 id="Create-an-Application-Gateway-on-Azure-Portal"><a href="#Create-an-Application-Gateway-on-Azure-Portal" class="headerlink" title="Create an Application Gateway on Azure Portal"></a>Create an Application Gateway on Azure Portal</h3><p>On the Azure Portal, select <strong>New</strong> &gt; <strong>Network</strong> &gt; <strong>Application Gateway</strong> to create an Application Gateway</p>
<h3 id="Basics-setting"><a href="#Basics-setting" class="headerlink" title="Basics setting"></a>Basics setting</h3><p>In <strong>Basics</strong> setting, you need to input the required parameters. In <strong>Tier</strong> dropdown list, you can select <strong>Standard V2</strong> or  <strong>WAF V2</strong> to enable **WAF ** feature on Application Gateway. </p>
<p><img src="/2021/10/12/integrate-ilb-asev3-with-application-gateway-en-us/image-20211011170309171.png" alt="image-20211011170309171.png"></p>
<h3 id="Frontends-setting"><a href="#Frontends-setting" class="headerlink" title="Frontends setting"></a>Frontends setting</h3><p>In <strong>Frontends</strong> setting, you need to select Frontend IP address type to <strong>Public</strong>, <strong>Private</strong> or <strong>Both</strong> . If you set to <strong>Private</strong></p>
<p>or <strong>Both</strong>, you will need to assign a static IP address in Application Gateway subnet range. In this case, we set to Public IP for public endpoint only.</p>
<ul>
<li>Public IP address - You will need to associate a public IP address for Application Gateway public access. Record this IP address, you will need to add a record in your DNS service later.</li>
</ul>
<p><img src="/2021/10/12/integrate-ilb-asev3-with-application-gateway-en-us/image-20211011170344207.png" alt="image-20211011170344207.png"></p>
<h3 id="Backends-setting"><a href="#Backends-setting" class="headerlink" title="Backends setting"></a>Backends setting</h3><p>In <strong>Frontends</strong> setting, you will need a backend pool name. You also need to select the <strong>App Services</strong> or <strong>IP address or FQDN</strong> in <strong>Target type</strong>. In this case, we set to <strong>App services</strong> and select app service name from the target dropdown list.</p>
<p><img src="/2021/10/12/integrate-ilb-asev3-with-application-gateway-en-us/image-20211011170358104.png" alt="image-20211011170358104"></p>
<h3 id="Configuration-setting"><a href="#Configuration-setting" class="headerlink" title="Configuration setting"></a>Configuration setting</h3><p>In <strong>Configuration</strong> setting, you need to add a routing rule by clicking <strong>Add a routing rule</strong> icon.</p>
<p><img src="/2021/10/12/integrate-ilb-asev3-with-application-gateway-en-us/image-20211011170426683.png"></p>
<p>You will need to configure a <strong>Listener</strong> and  <strong>Backend targets</strong> in a routing rule.</p>
<ul>
<li>The listener settings listed as below,</li>
</ul>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>Rule name</td>
<td>For example: https-routingrule</td>
<td>Routing name</td>
</tr>
<tr>
<td>Listener name</td>
<td>For example: https-listener</td>
<td>Listener name</td>
</tr>
<tr>
<td>Frontend IP</td>
<td>Public</td>
<td>For internet access, set to Public</td>
</tr>
<tr>
<td>Protocol</td>
<td>HTTPS</td>
<td>Use TLS/SSL encryption</td>
</tr>
<tr>
<td>Port</td>
<td>443</td>
<td>Default HTTPS Port</td>
</tr>
<tr>
<td>Https Settings</td>
<td>Upload a certificate</td>
<td>Upload a certificate contains the CN and the private key with .pfx format.</td>
</tr>
<tr>
<td>Listener type</td>
<td>Multi site</td>
<td>Allow to listen multi-sites on Application Gateway</td>
</tr>
<tr>
<td>Host type</td>
<td>Multiple/Wildcard</td>
<td>Set to multiple or wildcard website name if listener type is set to multi-sites.</td>
</tr>
<tr>
<td>Host name</td>
<td>For example:  app.asabuludemo.com</td>
<td>Set to a routable domain name for app service</td>
</tr>
</tbody></table>
<p><img src="/2021/10/12/integrate-ilb-asev3-with-application-gateway-en-us/image-20211011170557863.png" alt="image-20211011170557863"></p>
<ul>
<li>You will need to configure a <strong>Backend Pool</strong> and  <strong>HTTP setting</strong> in <strong>Backend targets</strong>. The Backend pool was configured in previously steps. You need to add a HTTP setting.</li>
</ul>
<p><img src="/2021/10/12/integrate-ilb-asev3-with-application-gateway-en-us/image-20211011170819884.png" alt="image-20211011170819884"></p>
<ul>
<li>HTTP settings listed as below:</li>
</ul>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>HTTP setting name</td>
<td>For example: https-setting</td>
<td>HTTP setting name</td>
</tr>
<tr>
<td>Backend protocol</td>
<td>HTTPS</td>
<td>Use TLS/SSL encryption</td>
</tr>
<tr>
<td>Backend port</td>
<td>443</td>
<td>Default HTTPS Port</td>
</tr>
<tr>
<td>Use well known CA certificate</td>
<td>Yes</td>
<td>The default domain name of ILB ASE is <strong>.appserviceenvironment.net</strong>, the certificate of this domain is issued by an public trusted root authority. In the Trusted root certificate setting, you can set to use <strong>well known CA trusted root certificate</strong>.</td>
</tr>
<tr>
<td>Override with new host name</td>
<td>Yes</td>
<td>The host name header will be overwrote on connecting to the app on ILB ASE</td>
</tr>
<tr>
<td>Host name override</td>
<td>Override with specific domain name<br />For example: app.asev3-ilb-20211008.appserviceenvironment.net</td>
<td>Set host name to the private DNS record of the app on ILB ASE</td>
</tr>
</tbody></table>
<p><img src="/2021/10/12/integrate-ilb-asev3-with-application-gateway-en-us/image-20211011170719016.png" alt="image-20211011170719016"></p>
<h2 id="Configure-Application-Gateway-integration-with-ILB-ASE"><a href="#Configure-Application-Gateway-integration-with-ILB-ASE" class="headerlink" title="Configure Application Gateway integration with ILB ASE"></a>Configure Application Gateway integration with ILB ASE</h2><p>After the Application Gateway had been created, there is a health probe had been provisioned. The health probe name is <em>httpsettings-{GUID}</em>. You may encounter an error as below when check the health probes. One of the reasons that Application Gateway probe cannot access to backend is failed to resolve the private domain name. To fix this issue, you need to add an virtual network link to private DNS zone.</p>
<p><code>Cannot connect to backend server. Check whether any NSG/UDR/Firewall is blocking access to the server. Check if application is running on correct port.</code></p>
<p><img src="/2021/10/12/integrate-ilb-asev3-with-application-gateway-en-us/image-20211011170904979.png" alt="image-20211011170904979"></p>
<h3 id="Configure-virtual-network-links-with-private-DNS-zone"><a href="#Configure-virtual-network-links-with-private-DNS-zone" class="headerlink" title="Configure virtual network links with private DNS zone"></a>Configure virtual network links with private DNS zone</h3><ul>
<li>To configure virtual network link with private DNS zone, go to the private DNS zone configuration plane. Select the <strong>Virtual network links</strong> &gt; <strong>+Add</strong> </li>
</ul>
<p><img src="/2021/10/12/integrate-ilb-asev3-with-application-gateway-en-us/image-20211012015548481.png" alt="image-20211012015548481"></p>
<ul>
<li>Input the <strong>Link name</strong> and select the respective subscription and virtual network where Application Gateway reside in.</li>
</ul>
<p><img src="/2021/10/12/integrate-ilb-asev3-with-application-gateway-en-us/image-20211011170928311.png"></p>
<h3 id="Configure-Health-Probe"><a href="#Configure-Health-Probe" class="headerlink" title="Configure Health Probe"></a>Configure Health Probe</h3><p>You can recreate the health probe to replace the default health probe when Application Gateway created. To configure the health probe, the key parameters listed as below,</p>
<ul>
<li>Health Probe settings:</li>
</ul>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>Health Probe</td>
<td>For example: https-probe</td>
<td>Health probe name</td>
</tr>
<tr>
<td>Protocol</td>
<td>HTTPS</td>
<td>Use TLS/SSL encryption</td>
</tr>
<tr>
<td>Host</td>
<td>For example:  app.asev3-ilb-20211008.appserviceenvironment.net</td>
<td>Set host name to the private DNS record of the app on ILB ASE</td>
</tr>
<tr>
<td>Pick host name form backend HTTP settings</td>
<td>No</td>
<td>Do not pick host name from backend as we set the Host explictly</td>
</tr>
<tr>
<td>Pick port from backend HTTP settings</td>
<td>Yes</td>
<td>Pick port from backend</td>
</tr>
<tr>
<td>Path</td>
<td>/</td>
<td>Use default root path</td>
</tr>
<tr>
<td>HTTP settings</td>
<td>https-setting</td>
<td>Use the HTTP setting on Application Gateway</td>
</tr>
</tbody></table>
<p><img src="/2021/10/12/integrate-ilb-asev3-with-application-gateway-en-us/image-20211011171017076.png" alt="image-20211011171017076"></p>
<p>Click Test button to test the backend health. Once the status is green, add to the Application Gateway.</p>
<p><img src="/2021/10/12/integrate-ilb-asev3-with-application-gateway-en-us/image-20211011171028680.png" alt="image-20211011171028680"></p>
<ul>
<li>Also confirm the backend health status from <strong>Backend health</strong> in the Application Gateway plane.</li>
</ul>
<p><img src="/2021/10/12/integrate-ilb-asev3-with-application-gateway-en-us/image-20211011171112275.png" alt="image-20211011171112275"></p>
<h3 id="Add-a-DNS-record"><a href="#Add-a-DNS-record" class="headerlink" title="Add a DNS record"></a>Add a DNS record</h3><p>You will need to configure a proper DNS mapping when access to Application Gateway from internet.</p>
<ul>
<li>The public IP address of Application Gateway can be found in <strong>Frontend IP configurations</strong> in Application Gateway plane.</li>
</ul>
<p><img src="/2021/10/12/integrate-ilb-asev3-with-application-gateway-en-us/image-20211012021450038.png" alt="image-20211012021450038"></p>
<ul>
<li>Use Azure DNS service as example, you can add a record set to map the app domain name to the public IP address of Application Gateway.</li>
</ul>
<p><img src="/2021/10/12/integrate-ilb-asev3-with-application-gateway-en-us/image-20211011161955209.png" alt="image-20211011161955209"></p>
<h3 id="Validate-connection"><a href="#Validate-connection" class="headerlink" title="Validate connection"></a>Validate connection</h3><ul>
<li>On a machine access from internet, you can verify the name resolution for the app domain name to Application Gateway public IP address.</li>
</ul>
<p><img src="/2021/10/12/integrate-ilb-asev3-with-application-gateway-en-us/image-20211011171252850.png"></p>
<ul>
<li>On a machine access from internet, test the web access from a browser.</li>
</ul>
<p><img src="/2021/10/12/integrate-ilb-asev3-with-application-gateway-en-us/image-20211011171302503.png" alt="image-20211011171302503"></p>
<hr>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/app-service/environment/intro">Azure App Service Environment</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/azure/application-gateway/overview">Azure Application Gateway</a> </li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/azure/app-service/environment/create-ilb-ase">Create an ILB ASE with ARM - Azure App Service Environment</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/azure/app-service/environment/create-from-template">Create an ASE with ARM - Azure App Service Environment</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/azure/dns/private-dns-getstarted-portal">Quickstart - Create an Azure private DNS zone using the Azure portal</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://samlin-msft.github.io/2021/10/11/integrate-ilb-asev3-with-application-gateway/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avator.png">
      <meta itemprop="name" content="Sam Lin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雜七雜八。有的沒的">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/11/integrate-ilb-asev3-with-application-gateway/" class="post-title-link" itemprop="url">整合內部負載平衡 ASEv3 與 Application Gateway</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-10-11 14:52:32" itemprop="dateCreated datePublished" datetime="2021-10-11T14:52:32+08:00">2021-10-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-10-12 07:05:26" itemprop="dateModified" datetime="2021-10-12T07:05:26+08:00">2021-10-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/App-Service-Environment/" itemprop="url" rel="index"><span itemprop="name">App Service Environment</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/app-service/environment/intro">Azure App Service Environment</a> 是一個部署於客戶的 VNet 以及 Subnet 的 App Service 環境, 可以將 App Service 的存取部署為公開存取點 (public endpoint) 或私有存取點 (private endpoint). 當部署為私有存取點的 ASE, 在內部會生成一個內部負載平衡器 (internal load balancer) 的 App Service 環境, 稱為 ILB App Service Environment.</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/azure/application-gateway/overview">Azure Application Gateway</a> 是一個 Layer 7 流量負載平衡器的虛擬設備 (virtual appliance), 取決於網站路由設定以及根據 HTTP 請求內容, 管理應用程式存取的存取, 支援 TLS/SSL offloading, 也可以附加應用程式防火牆 (WAF) 功能.</p>
<p>整合 ASE 以及 Application Gateway 可以將 App Service 安全的隔離在 ILB ASE 中, 使用 Application Gateway/WAF 開放給外部存取並使用 應用程式防火牆來做網站安全防護.</p>
<p><img src="/2021/10/11/integrate-ilb-asev3-with-application-gateway/image-20211011152138347.png" alt="image-20211011152138347"></p>
<p>本篇文章將帶領您:</p>
<ul>
<li>建立一個 Azure Application Gateway</li>
<li>設定 Application Gateway 並指向您 ILB ASEv3 中的 App Service</li>
</ul>
<h2 id="先決條件"><a href="#先決條件" class="headerlink" title="先決條件"></a>先決條件</h2><p>整合 Application Gateway 以及 ILB App Service Environment 時, 您將需要以下的準備事項:</p>
<ul>
<li>一個 ILB ASE 環境</li>
<li>ILB ASE 所對應的的私有 DNS 區域 (private DNS zone)</li>
<li>一個執行於 ILB ASE 環境的 App Service</li>
<li>一個公開的網域名稱用以指向 Application Gateway</li>
<li>一張公開發行且有效的憑證用以綁定 Application Gateway</li>
</ul>
<h3 id="ILB-ASE-環境"><a href="#ILB-ASE-環境" class="headerlink" title="ILB ASE 環境"></a>ILB ASE 環境</h3><p>您可以從 Azure Portal 建立 ILB ASE 環境, 參考  <a target="_blank" rel="noopener" href="https://docs.microsoft.com/azure/app-service/environment/create-ilb-ase">Create an ILB ASE with ARM - Azure App Service Environment</a> 或由 Template 建立, 參考 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/azure/app-service/environment/create-from-template">Create an ASE with ARM - Azure App Service Environment</a>. </p>
<ul>
<li>建立完成 ILB ASE 後, 預設所使用的根網域將會是 <code>&lt;YourAseName&gt;.appserviceenvironment.net</code> </li>
</ul>
<p><img src="/2021/10/11/integrate-ilb-asev3-with-application-gateway/image-20211011155312176.png" alt="image-20211011155312176"></p>
<ul>
<li>建立完成 ILB ASE 後, 會指派 internel load balancer 的 IP 做為 Inbound Address</li>
</ul>
<p><img src="/2021/10/11/integrate-ilb-asev3-with-application-gateway/image-20211011160529160.png" alt="image-20211011160529160"></p>
<h3 id="私有-DNS-區域"><a href="#私有-DNS-區域" class="headerlink" title="私有 DNS 區域"></a>私有 DNS 區域</h3><p>私有 DNS 區域可以在建立 ILB ASE 時同時建立, 若建立 ASE 時沒有建立, 可以在 ASE 完成後再行建立, 透過 Azure Portal 建立可以參考 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/azure/dns/private-dns-getstarted-portal">Quickstart - Create an Azure private DNS zone using the Azure portal</a>, 對應的 Record Sets 如下:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Value</th>
</tr>
</thead>
<tbody><tr>
<td>*</td>
<td>A</td>
<td>ASE inbound address</td>
</tr>
<tr>
<td>@</td>
<td>A</td>
<td>ASE inbound address</td>
</tr>
<tr>
<td>@</td>
<td>SOA</td>
<td>ASE DNS name</td>
</tr>
<tr>
<td>*.scm</td>
<td>A</td>
<td>ASE inbound address</td>
</tr>
</tbody></table>
<p><img src="/2021/10/11/integrate-ilb-asev3-with-application-gateway/image-20211011155613716.png" alt="image-20211011155613716"></p>
<h3 id="App-Service-on-ILB-ASE"><a href="#App-Service-on-ILB-ASE" class="headerlink" title="App Service on ILB ASE"></a>App Service on ILB ASE</h3><p>建立完成 ILB ASE 後, 您可以從 Azure Portal 上建立 App Service, 其中在選擇 “<strong>Region</strong>“ 時, 要從下拉選單中選取您所建立的  ILB ASE, 才能將 App Service 建立到 ILB ASE 上.</p>
<p><img src="/2021/10/11/integrate-ilb-asev3-with-application-gateway/image-20211011164224837.png" alt="image-20211011164224837"></p>
<h3 id="App-Service-的網域名稱"><a href="#App-Service-的網域名稱" class="headerlink" title="App Service 的網域名稱"></a>App Service 的網域名稱</h3><p>要從 Internet 可以連線到 Application Gateway 上, 要先有一個可以從 Internet 存取到的公開網域, 以本文為例, 使用的公開網域的名稱為 <code>asabuludemo.com</code>, 所規劃的 app service 公開的網域名稱為 <code>app.asabuludemo.com</code> , 對應的 IP 位址將會是後面所建立的 Application Gateway 公開 IP.</p>
<h3 id="公開發行且有效的憑證"><a href="#公開發行且有效的憑證" class="headerlink" title="公開發行且有效的憑證"></a>公開發行且有效的憑證</h3><p>前述所需要的 app 公開網域名稱若需要綁定 TLS/SSL 憑證, 對於公開網站, 強烈建議一定要綁定 TLS/SSL 憑證加密傳輸通道. 因此您需要準備一張公開憑證對應到你的公開網域, 憑證<strong>一般名稱 (Common Name;CN)</strong> 以及<strong>主題備用名稱 (Subject Alternative Name;SAN)</strong> 分別設定如下:</p>
<ul>
<li>Common Name: <code>*.&lt;yourdomainname&gt;</code> 例如 <code>*.asabuludemo.com</code></li>
<li>Subject Alternative Name: <code>*.scm.&lt;yourdomainname&gt;</code> 例如 <code>*.scm.asabuludemo.com</code>, 此 SAN 設定可以允許您從 Application Gateway 存取後台的 App 網站管理介面, 如果考量不對外開放後台管理介面從 Application Gateway 進入, 則可以忽略這個 SAN 設定.</li>
</ul>
<p>您需要將憑證檔案儲存成含有私鑰的 .pfx 格式以便後續建立 Application Gateway 時匯入.</p>
<h2 id="建立-Application-Gateway"><a href="#建立-Application-Gateway" class="headerlink" title="建立 Application Gateway"></a>建立 Application Gateway</h2><p>本範例將使用 Azure Portal 建立 Application Gateway 整合 ILB ASE 環境</p>
<h3 id="從-Azure-Portal-建立-Application-Gateway"><a href="#從-Azure-Portal-建立-Application-Gateway" class="headerlink" title="從 Azure Portal 建立 Application Gateway"></a>從 Azure Portal 建立 Application Gateway</h3><p>開啟 Azure Portal, 選取 <strong>“New”</strong> &gt; <strong>“Network”</strong> &gt; <strong>“Application Gateway”</strong> 建立 Application Gateway</p>
<h3 id="Basics-設定"><a href="#Basics-設定" class="headerlink" title="Basics 設定"></a>Basics 設定</h3><p>依照設定精靈, 在 Basics 設定選項中, 您需要設定必要的參數, 其中在 <strong>“Tier”</strong> 下拉清單中, 您可以選擇 WAF V2 附加 WAF 功能或 Standard V2 暫時不附加 WAF 功能, 您可在設定完成後再行附加 WAF 功能.</p>
<p><img src="/2021/10/11/integrate-ilb-asev3-with-application-gateway/image-20211011170309171.png" alt="image-20211011170309171.png"></p>
<h3 id="Frontends-設定"><a href="#Frontends-設定" class="headerlink" title="Frontends 設定"></a>Frontends 設定</h3><p>在 Frontends 設定選項中, 您需要決定 Application Gateway 所接聽的 IP 為公開或私有, 或兩者皆指派, 若您選取私有 IP, 您必須指派 Application Gateway Subnet 中尚未被使用的靜態 IP 做為私有 IP. 本範例以公開 IP 設定為例.</p>
<ul>
<li>公開 IP - 您需要綁定一個公開 IP 做為 Application Gateway 公開存取端點. 請紀錄這個 IP, 後續新增 DNS 記錄時會需要使用.</li>
</ul>
<p><img src="/2021/10/11/integrate-ilb-asev3-with-application-gateway/image-20211011170344207.png" alt="image-20211011170344207.png"></p>
<h3 id="Backends-設定"><a href="#Backends-設定" class="headerlink" title="Backends 設定"></a>Backends 設定</h3><p>在 Backends 設定選項中, 您需要後端 Pool 名稱, 並且在 <strong>“Target type”</strong> 中, 選擇 <strong>“App Services”</strong> 或 <strong>“IP address or FQDN”</strong>, 本範例選擇 <strong>“app services”</strong> 並指派對應的 <strong>“Target”</strong></p>
<p><img src="/2021/10/11/integrate-ilb-asev3-with-application-gateway/image-20211011170358104.png" alt="image-20211011170358104"></p>
<h3 id="Configuration-設定"><a href="#Configuration-設定" class="headerlink" title="Configuration 設定"></a>Configuration 設定</h3><p>在 Configuration 設定選項中, 您需要新增一個<strong>路由規則</strong>, 請點選 <strong>“Add a routing rule”</strong> 進行設定</p>
<p><img src="/2021/10/11/integrate-ilb-asev3-with-application-gateway/image-20211011170426683.png"></p>
<p>路由規則是由 <strong>“Listener”</strong> 和 <strong>“Backend targets”</strong> 設定組合</p>
<ul>
<li>Listener 設定說明如下:</li>
</ul>
<table>
<thead>
<tr>
<th>參數名稱</th>
<th>參數值</th>
<th>說明</th>
</tr>
</thead>
<tbody><tr>
<td>Rule name</td>
<td>例: https-routingrule</td>
<td>路由名稱</td>
</tr>
<tr>
<td>Listener name</td>
<td>例: https-listener</td>
<td>接聽名稱</td>
</tr>
<tr>
<td>Frontend IP</td>
<td>Public</td>
<td>對外接聽, 設定為 Public</td>
</tr>
<tr>
<td>Protocol</td>
<td>HTTPS</td>
<td>採用 TLS/SSL 加密</td>
</tr>
<tr>
<td>Port</td>
<td>443</td>
<td>預設 HTTPS Port</td>
</tr>
<tr>
<td>Https Settings</td>
<td>Upload a certificate</td>
<td>上傳一個具有私鑰且 CN 名稱對應為 app 網域名稱的 .pfx 格式公開憑證檔案</td>
</tr>
<tr>
<td>Listener type</td>
<td>Multi site</td>
<td>Application Gateway 允許接聽多個網站</td>
</tr>
<tr>
<td>Host type</td>
<td>Multiple/Wildcard</td>
<td>可以設定多個或 wildcard 網站名稱</td>
</tr>
<tr>
<td>Host name</td>
<td>例: app.asabuludemo.com</td>
<td>設定為 app 網站外部可存取的網域名稱</td>
</tr>
</tbody></table>
<p><img src="/2021/10/11/integrate-ilb-asev3-with-application-gateway/image-20211011170557863.png" alt="image-20211011170557863"></p>
<ul>
<li>Backend targets 設定包含 <strong>“Backend Pool”</strong> 以及 <strong>“HTTP setting”</strong>, Backend pool 已經在前面步驟設定, 因此您需要新增一個 HTTP setting</li>
</ul>
<p><img src="/2021/10/11/integrate-ilb-asev3-with-application-gateway/image-20211011170819884.png" alt="image-20211011170819884"></p>
<ul>
<li>HTTP 設定主要參數說明如下:</li>
</ul>
<table>
<thead>
<tr>
<th>參數名稱</th>
<th>參數值</th>
<th>說明</th>
</tr>
</thead>
<tbody><tr>
<td>HTTP setting name</td>
<td>例: https-setting</td>
<td>HTTP 設定名稱</td>
</tr>
<tr>
<td>Backend protocol</td>
<td>HTTPS</td>
<td>採用 TLS/SSL 加密</td>
</tr>
<tr>
<td>Backend port</td>
<td>443</td>
<td>預設 HTTPS Port</td>
</tr>
<tr>
<td>Use well known CA certificate</td>
<td>Yes</td>
<td>由於內建後端的 ILB ASE 環境預設的 .appserviceenvironment.net 網域是有效的公開憑證, 因此在 Application Gateway 中只需選取 well known CA trusted root certificate</td>
</tr>
<tr>
<td>Override with new host name</td>
<td>Yes</td>
<td>後端連線到 ILB ASE 上的 app 需要進行 host name header 置換</td>
</tr>
<tr>
<td>Host name override</td>
<td>Override with specific domain name<br />例: app.asev3-ilb-20211008.appserviceenvironment.net</td>
<td>Host name 需要指派到 ILB ASE 上的 app 對應的網域名稱</td>
</tr>
</tbody></table>
<p><img src="/2021/10/11/integrate-ilb-asev3-with-application-gateway/image-20211011170719016.png" alt="image-20211011170719016"></p>
<h2 id="整合-Application-Gateway-設定"><a href="#整合-Application-Gateway-設定" class="headerlink" title="整合 Application Gateway 設定"></a>整合 Application Gateway 設定</h2><p>Application Gateway 建立完成後, 您需要檢查 Health Probes 狀況, 若出現以下的錯誤時, 表示 Application Gateway 無法正確解析到 ILB ASE 上的 app 網域名稱, 您必須先設定好 Private DNS Zone 虛擬網路連結設定</p>
<p><code>Cannot connect to backend server. Check whether any NSG/UDR/Firewall is blocking access to the server. Check if application is running on correct port.</code></p>
<p><img src="/2021/10/11/integrate-ilb-asev3-with-application-gateway/image-20211011170904979.png" alt="image-20211011170904979"></p>
<h3 id="Private-DNS-Zone-虛擬網路連結設定"><a href="#Private-DNS-Zone-虛擬網路連結設定" class="headerlink" title="Private DNS Zone 虛擬網路連結設定"></a>Private DNS Zone 虛擬網路連結設定</h3><ul>
<li>進入 <strong>Private DNS Zone</strong> &gt; <strong>“Virtual network links”</strong> &gt; <strong>“+Add”</strong> 新增虛擬網路連結 </li>
</ul>
<p><img src="/2021/10/11/integrate-ilb-asev3-with-application-gateway/image-20211012015548481.png" alt="image-20211012015548481"></p>
<ul>
<li>輸入連結名稱並選擇訂閱上的 Application Gateway 所在的虛擬網路名稱進行連結</li>
</ul>
<p><img src="/2021/10/11/integrate-ilb-asev3-with-application-gateway/image-20211011170928311.png"></p>
<h3 id="設定-Health-Probe"><a href="#設定-Health-Probe" class="headerlink" title="設定 Health Probe"></a>設定 Health Probe</h3><p>若 Health probe 已經在 Application Gateway 建立時已經產生, 您可以先將其刪除並重新設定 Health Probe</p>
<ul>
<li>Health Probe 設定主要參數說明如下:</li>
</ul>
<table>
<thead>
<tr>
<th>參數名稱</th>
<th>參數值</th>
<th>說明</th>
</tr>
</thead>
<tbody><tr>
<td>Health Probe</td>
<td>例: https-probe</td>
<td>健康探查名稱</td>
</tr>
<tr>
<td>Protocol</td>
<td>HTTPS</td>
<td>採用 TLS/SSL 加密</td>
</tr>
<tr>
<td>Host</td>
<td>例: app.asev3-ilb-20211008.appserviceenvironment.net</td>
<td>Host name 需要指派到 ILB ASE 上的 app 對應的網域名稱</td>
</tr>
<tr>
<td>Pick host name form backend HTTP settings</td>
<td>No</td>
<td>不需要從後端取得 Host name</td>
</tr>
<tr>
<td>Pick port from backend HTTP settings</td>
<td>Yes</td>
<td>從後端取得 Port</td>
</tr>
<tr>
<td>Path</td>
<td>/</td>
<td>使用預設的 root 路徑</td>
</tr>
<tr>
<td>HTTP settings</td>
<td>https-setting</td>
<td>使用 Application Gateway 中的 HTTP setting</td>
</tr>
</tbody></table>
<p><img src="/2021/10/11/integrate-ilb-asev3-with-application-gateway/image-20211011171017076.png" alt="image-20211011171017076"></p>
<p>測試 Health Probe 狀態為綠燈後, 新增至 Application Gateway</p>
<p><img src="/2021/10/11/integrate-ilb-asev3-with-application-gateway/image-20211011171028680.png" alt="image-20211011171028680"></p>
<ul>
<li>確認 Backend health 狀態為 Health</li>
</ul>
<p><img src="/2021/10/11/integrate-ilb-asev3-with-application-gateway/image-20211011171112275.png" alt="image-20211011171112275"></p>
<h3 id="設定-DNS-對應"><a href="#設定-DNS-對應" class="headerlink" title="設定 DNS 對應"></a>設定 DNS 對應</h3><p>從 Internet 存取 Application Gateway 時, 需要先設定好 DNS 對應</p>
<ul>
<li>Application Gateway 公開 IP 可以從 Application Gateway 的 Frontend IP configurations 設定取得</li>
</ul>
<p><img src="/2021/10/11/integrate-ilb-asev3-with-application-gateway/image-20211012021450038.png" alt="image-20211012021450038"></p>
<ul>
<li>設定 DNS 對應, 以 Azure DNS 服務為例, 您可以新增一筆記錄, 對應到 Application Gateway 所設定的網站網域名稱</li>
</ul>
<p><img src="/2021/10/11/integrate-ilb-asev3-with-application-gateway/image-20211011161955209.png" alt="image-20211011161955209"></p>
<h3 id="驗證連線"><a href="#驗證連線" class="headerlink" title="驗證連線"></a>驗證連線</h3><ul>
<li>從外部的主機, 可以驗證名稱解析是否正確</li>
</ul>
<p><img src="/2021/10/11/integrate-ilb-asev3-with-application-gateway/image-20211011171252850.png"></p>
<ul>
<li>從外部的主機, 開啟瀏覽器, 連線到 Application Gateway 所設定的網站是否可以正常存取</li>
</ul>
<p><img src="/2021/10/11/integrate-ilb-asev3-with-application-gateway/image-20211011171302503.png" alt="image-20211011171302503"></p>
<hr>
<h2 id="參考"><a href="#參考" class="headerlink" title="參考"></a>參考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/app-service/environment/intro">Azure App Service Environment</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/azure/application-gateway/overview">Azure Application Gateway</a> </li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/azure/app-service/environment/create-ilb-ase">Create an ILB ASE with ARM - Azure App Service Environment</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/azure/app-service/environment/create-from-template">Create an ASE with ARM - Azure App Service Environment</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/azure/dns/private-dns-getstarted-portal">Quickstart - Create an Azure private DNS zone using the Azure portal</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://samlin-msft.github.io/2021/10/05/create-an-asev3-from-arm-templates/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avator.png">
      <meta itemprop="name" content="Sam Lin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雜七雜八。有的沒的">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/05/create-an-asev3-from-arm-templates/" class="post-title-link" itemprop="url">Create an ASEv3 from ARM templates</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-10-05 00:30:56 / Modified: 02:56:50" itemprop="dateCreated datePublished" datetime="2021-10-05T00:30:56+08:00">2021-10-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/App-Service-Environment/" itemprop="url" rel="index"><span itemprop="name">App Service Environment</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>Azure App Service environments (ASEs) can be created with an internet-accessible endpoint or an endpoint on an internal address in an Azure virtual network (VNet). When created with an internal endpoint, that endpoint is provided by an Azure component called an internal load balancer (ILB). The ASE on an internal IP address is called an ILB ASE. The ASE with a public endpoint is called an External ASE. </p>
<p>An ASE can be created by using the Azure portal or an Azure Resource Manager template. This article walks through the steps and syntax you need to create an External ASE or ILB ASE with templates. To learn how to create an ASEv3 in the Azure portal, see <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/app-service/environment/creation">Create an App Service Environment - Azure App Service Environment</a>.</p>
<p>When you create an ASEv3 in the Azure portal, you can create your VNet at the same time or choose a preexisting VNet to deploy into. When you create an ASE from a template, you must start with: </p>
<ul>
<li>A Resource Manager VNet.</li>
<li>A subnetin that VNet. We recommend an ASE subnetsize of <code>/24</code> with 256 addresses to accommodate future growth and scaling needs. After the ASE is created, you can’t change the size.</li>
<li>The resource group of your VNet. You can get this information from the Azure portal under your virtual network properties.</li>
<li>The subscription you want to deploy into.</li>
<li>The location you want to deploy into.</li>
</ul>
<p>To automate your ASEv3 creation:</p>
<ol>
<li><p>Create the ASEv3 from a template.</p>
</li>
<li><p>After your ILB ASEv3 is created, an private DNS zone will be created if you set <em>createPrivateDNS</em> parameter to true.</p>
</li>
</ol>
<h2 id="Create-the-ASEv3"><a href="#Create-the-ASEv3" class="headerlink" title="Create the ASEv3"></a>Create the ASEv3</h2><p>A Resource Manager template that creates an ASE and its associated parameters file is available <a target="_blank" rel="noopener" href="https://azure.microsoft.com/en-us/resources/templates/web-app-asp-app-on-asev3-create/">in an example</a> on GitHub.</p>
<p>If you want to make an ASEv3, use these Resource Manager template <a target="_blank" rel="noopener" href="https://github.com/Azure/azure-quickstart-templates/tree/master/quickstarts/microsoft.web/web-app-asp-app-on-asev3-create">example</a>. They cater to that use case. Most of the parameters in the <em>azuredeploy.parameters.json</em> file are common to the creation of ILB ASEs and External ASEs. The following list calls out parameters of special note, or that are unique, when you create an ILB ASE with an existing subnet:</p>
<ul>
<li><em>aseName</em>: Required. This parameter defines an unique ASE name. </li>
<li><em>internalLoadBalancingMode</em>: Required. In most cases, set this to 3, which means both HTTP/HTTPS traffic on ports 80/443, and the control/data channel ports listened to by the FTP service on the ASE, will be bound to an ILB-allocated virtual network internal address. If this property is set to 2, only the FTP service-related ports (both control and data channels) are bound to an ILB address. The HTTP/HTTPS traffic remains on the public VIP.</li>
<li><em>zoneRedundant</em>: Required. In most cases, set this to false, which means the ASE will not be deployed into Availability Zones(AZ). Zonal ASEs can be deployed in some regions, you can refer to <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/app-service/environment/zone-redundancy">this</a>.</li>
<li><em>dedicatedHostCount</em>: Required. In most cases, set this to 0, which means the ASE will be deployed as normal without dedicated hosts deployed.</li>
<li><em>useExistingVnetandSubnet</em>: Required. Set to true if using an existing VNet and subnet. </li>
<li><em>vNetResourceGroupName</em>: Required if an using existing VNET and Subnet. This parameter defines the resource group name of the existing VNet and subnet where ASE will reside.</li>
<li><em>virtualNetworkName</em>: Required if using an existing VNet and Subnet. This parameter defines the virtual network name of the existing VNet and subnet where ASE will reside.</li>
<li><em>subnetName</em>: Required if using an existing VNet and Subnet. This parameter defines the subnet name of the existing VNet and subnet where ASE will reside.</li>
<li><em>createPrivateDNS</em>: Set to true if you want to create a private DNS zone after ASEv3 created. For an ILB ASE, when set this parameter to true, it will create a private DNS zone as ASE name with <em>appserviceenvironment.net</em> DNS suffix. </li>
</ul>
<p>After the <em>azuredeploy.parameters.json</em> file is filled in, create the ASE by using the PowerShell code snippet. Change the file paths to match the Resource Manager template-file locations on your machine. Remember to supply your own values for the Resource Manager deployment name and the resource group name:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$templatePath</span>=<span class="string">&quot;PATH\azuredeploy.json&quot;</span></span><br><span class="line"><span class="variable">$parameterPath</span>=<span class="string">&quot;PATH\azuredeploy.parameters.json&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">New-AzResourceGroupDeployment</span> <span class="literal">-Name</span> <span class="string">&quot;CHANGEME&quot;</span> <span class="literal">-ResourceGroupName</span> <span class="string">&quot;YOUR-RG-NAME-HERE&quot;</span> <span class="literal">-TemplateFile</span> <span class="variable">$templatePath</span> <span class="literal">-TemplateParameterFile</span> <span class="variable">$parameterPath</span></span><br></pre></td></tr></table></figure>

<p>It takes about two hours for the ASEv3 to be created. Then the ASEv3 shows up in the portal in the list of ASEs for the subscription that triggered the deployment.</p>
<hr>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/app-service/environment/create-from-template">Create an ASE with ARM - Azure App Service Environment</a></li>
<li><a target="_blank" rel="noopener" href="https://azure.microsoft.com/en-us/resources/templates/web-app-asp-app-on-asev3-create/">Create an AppServicePlan and App in an ASEv3</a></li>
<li>[Availability Zone support for App Service Environments - Azure App Service Environment](</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://samlin-msft.github.io/2021/10/05/create-an-asev3-from-terraform-templates/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avator.png">
      <meta itemprop="name" content="Sam Lin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雜七雜八。有的沒的">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/05/create-an-asev3-from-terraform-templates/" class="post-title-link" itemprop="url">Create an ASEv3 from terraform templates</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-10-05 00:30:56 / Modified: 02:45:55" itemprop="dateCreated datePublished" datetime="2021-10-05T00:30:56+08:00">2021-10-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/App-Service-Environment/" itemprop="url" rel="index"><span itemprop="name">App Service Environment</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>App Service Environment (ASE), provides an isolated and dedicated host environment for securely running app service at high scale. In ASEv3 there are 6 deployment types listed as following examples.  In each example, you will need to edit the variables in <code>terraform.tfvars</code>.</p>
<ul>
<li>ILB ASEv3 (<code>internal_load_balancing_mode</code> = <code>&quot;Web, Publishing&quot;</code> and <code>zone_redundant</code> = <code>false</code>)</li>
<li>ELB ASEv3 (<code>internal_load_balancing_mode</code> = <code>&quot;None&quot;</code> and <code>zone_redundant</code> = <code>false</code>)</li>
<li>ILB ASEv3 with AZ support (<code>internal_load_balancing_mode</code> = <code>&quot;Web, Publishing&quot;</code> and <code>zone_redundant</code> = <code>true</code>)</li>
<li>ELB ASEv3 with AZ support (<code>internal_load_balancing_mode</code> = <code>&quot;None&quot;</code> and <code>zone_redundant</code> = <code>true</code>)</li>
<li>ILB ASEv3 with dedicated hosts (<code>internal_load_balancing_mode</code> = <code>&quot;Web, Publishing&quot;</code> and <code>dedicated_host_count</code> = <code>2</code>)</li>
<li>ELB ASEv3 with dedicated hosts (<code>internal_load_balancing_mode</code> = <code>&quot;None&quot;</code> and <code>dedicated_host_count</code> = <code>2</code>)</li>
</ul>
<p>If you’re going to deploy an ASEv3 on an existing subnet, there is an import task you need to complete before apply the terraform.</p>
<h2 id="Terraform-and-Variables-templates"><a href="#Terraform-and-Variables-templates" class="headerlink" title="Terraform and Variables templates"></a>Terraform and Variables templates</h2><p>This example provisions an App Service Environment V3. Additional examples of how to use the azurerm_app_service_environment_v3 resource.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># variables.tf</span></span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;ase_resource_group_name&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span> <span class="string">=</span> <span class="string">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;use_existing_vnet_and_subnet&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span>    <span class="string">=</span> <span class="string">bool</span></span><br><span class="line">  <span class="string">default</span> <span class="string">=</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;vnet_resource_group_name&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span> <span class="string">=</span> <span class="string">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;virtual_network_name&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span> <span class="string">=</span> <span class="string">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;location&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span> <span class="string">=</span> <span class="string">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;vnet_address_prefixes&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span>    <span class="string">=</span> <span class="string">list(string)</span></span><br><span class="line">  <span class="string">default</span> <span class="string">=</span> [<span class="string">&quot;172.16.0.0/16&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;subnet_name&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span> <span class="string">=</span> <span class="string">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;subnet_address_prefixes&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span>    <span class="string">=</span> <span class="string">list(string)</span></span><br><span class="line">  <span class="string">default</span> <span class="string">=</span> [<span class="string">&quot;172.16.0.0/24&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;ase_name&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span> <span class="string">=</span> <span class="string">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;dedicated_host_count&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span>    <span class="string">=</span> <span class="string">number</span></span><br><span class="line">  <span class="string">default</span> <span class="string">=</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;zone_redundant&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span>    <span class="string">=</span> <span class="string">bool</span></span><br><span class="line">  <span class="string">default</span> <span class="string">=</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;create_private_dns&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span>    <span class="string">=</span> <span class="string">bool</span></span><br><span class="line">  <span class="string">default</span> <span class="string">=</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;internal_load_balancing_mode&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span>    <span class="string">=</span> <span class="string">string</span></span><br><span class="line">  <span class="string">default</span> <span class="string">=</span> <span class="string">&quot;Web, Publishing&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;network_security_group_name&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span> <span class="string">=</span> <span class="string">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;network_security_group_security_rules&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span>    <span class="string">=</span> <span class="string">any</span></span><br><span class="line">  <span class="string">default</span> <span class="string">=</span> []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># main.tf</span></span><br><span class="line"><span class="string">terraform</span> &#123;</span><br><span class="line">  <span class="string">required_providers</span> &#123;</span><br><span class="line">    <span class="string">azurerm</span> <span class="string">=</span> &#123;</span><br><span class="line">      <span class="string">version</span> <span class="string">=</span> <span class="string">&quot;&gt;=2.76.0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">random</span> <span class="string">=</span> &#123;</span><br><span class="line">      <span class="string">version</span> <span class="string">=</span> <span class="string">&quot;3.1.0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">provider</span> <span class="string">&quot;azurerm&quot;</span> &#123;</span><br><span class="line">  <span class="string">features</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">resource</span> <span class="string">&quot;azurerm_resource_group&quot;</span> <span class="string">&quot;rg&quot;</span> &#123;</span><br><span class="line">  <span class="string">name</span>     <span class="string">=</span> <span class="string">var.ase_resource_group_name</span></span><br><span class="line">  <span class="string">location</span> <span class="string">=</span> <span class="string">var.location</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">data</span> <span class="string">&quot;azurerm_subnet&quot;</span> <span class="string">&quot;snet-exist&quot;</span> &#123;</span><br><span class="line">  <span class="string">count</span>                <span class="string">=</span> <span class="string">var.use_existing_vnet_and_subnet</span> <span class="string">?</span> <span class="attr">1 :</span> <span class="number">0</span></span><br><span class="line">  <span class="string">name</span>                 <span class="string">=</span> <span class="string">var.subnet_name</span></span><br><span class="line">  <span class="string">virtual_network_name</span> <span class="string">=</span> <span class="string">var.virtual_network_name</span></span><br><span class="line">  <span class="string">resource_group_name</span>  <span class="string">=</span> <span class="string">var.vnet_resource_group_name</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">resource</span> <span class="string">&quot;azurerm_network_security_group&quot;</span> <span class="string">&quot;nsg&quot;</span> &#123;</span><br><span class="line">  <span class="string">count</span>               <span class="string">=</span> <span class="string">var.use_existing_vnet_and_subnet</span> <span class="string">?</span> <span class="attr">0 :</span> <span class="number">1</span></span><br><span class="line">  <span class="string">name</span>                <span class="string">=</span> <span class="string">var.network_security_group_name</span></span><br><span class="line">  <span class="string">location</span>            <span class="string">=</span> <span class="string">azurerm_resource_group.rg.location</span></span><br><span class="line">  <span class="string">resource_group_name</span> <span class="string">=</span> <span class="string">azurerm_resource_group.rg.name</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">resource</span> <span class="string">&quot;azurerm_virtual_network&quot;</span> <span class="string">&quot;vnet&quot;</span> &#123;</span><br><span class="line">  <span class="string">count</span>               <span class="string">=</span> <span class="string">var.use_existing_vnet_and_subnet</span> <span class="string">?</span> <span class="attr">0 :</span> <span class="number">1</span></span><br><span class="line">  <span class="string">name</span>                <span class="string">=</span> <span class="string">var.virtual_network_name</span></span><br><span class="line">  <span class="string">location</span>            <span class="string">=</span> <span class="string">azurerm_resource_group.rg.location</span></span><br><span class="line">  <span class="string">resource_group_name</span> <span class="string">=</span> <span class="string">azurerm_resource_group.rg.name</span></span><br><span class="line">  <span class="string">address_space</span>       <span class="string">=</span> <span class="string">var.vnet_address_prefixes</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">resource</span> <span class="string">&quot;azurerm_subnet&quot;</span> <span class="string">&quot;snet&quot;</span> &#123;</span><br><span class="line">  <span class="string">count</span>                <span class="string">=</span> <span class="string">var.use_existing_vnet_and_subnet</span> <span class="string">?</span> <span class="attr">0 :</span> <span class="number">1</span></span><br><span class="line">  <span class="string">name</span>                 <span class="string">=</span> <span class="string">var.subnet_name</span></span><br><span class="line">  <span class="string">resource_group_name</span>  <span class="string">=</span> <span class="string">azurerm_resource_group.rg.name</span></span><br><span class="line">  <span class="string">virtual_network_name</span> <span class="string">=</span> <span class="string">azurerm_virtual_network.vnet</span>[<span class="number">0</span>]<span class="string">.name</span></span><br><span class="line">  <span class="string">address_prefixes</span>     <span class="string">=</span> <span class="string">var.subnet_address_prefixes</span></span><br><span class="line"></span><br><span class="line">  <span class="string">delegation</span> &#123;</span><br><span class="line">    <span class="string">name</span> <span class="string">=</span> <span class="string">&quot;Microsoft.Web.hostingEnvironments&quot;</span></span><br><span class="line">    <span class="string">service_delegation</span> &#123;</span><br><span class="line">      <span class="string">name</span>    <span class="string">=</span> <span class="string">&quot;Microsoft.Web/hostingEnvironments&quot;</span></span><br><span class="line">      <span class="string">actions</span> <span class="string">=</span> [<span class="string">&quot;Microsoft.Network/virtualNetworks/subnets/action&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">resource</span> <span class="string">&quot;azurerm_subnet&quot;</span> <span class="string">&quot;snet-delegation&quot;</span> &#123;</span><br><span class="line">  <span class="string">count</span>                <span class="string">=</span> <span class="string">var.use_existing_vnet_and_subnet</span> <span class="string">?</span> <span class="attr">1 :</span> <span class="number">0</span></span><br><span class="line">  <span class="string">name</span>                 <span class="string">=</span> <span class="string">var.subnet_name</span></span><br><span class="line">  <span class="string">virtual_network_name</span> <span class="string">=</span> <span class="string">var.virtual_network_name</span></span><br><span class="line">  <span class="string">resource_group_name</span>  <span class="string">=</span> <span class="string">var.vnet_resource_group_name</span></span><br><span class="line">  <span class="string">address_prefixes</span>     <span class="string">=</span> <span class="string">data.azurerm_subnet.snet-exist</span>[<span class="number">0</span>]<span class="string">.address_prefixes</span></span><br><span class="line"></span><br><span class="line">  <span class="string">delegation</span> &#123;</span><br><span class="line">    <span class="string">name</span> <span class="string">=</span> <span class="string">&quot;Microsoft.Web.hostingEnvironments&quot;</span></span><br><span class="line">    <span class="string">service_delegation</span> &#123;</span><br><span class="line">      <span class="string">name</span>    <span class="string">=</span> <span class="string">&quot;Microsoft.Web/hostingEnvironments&quot;</span></span><br><span class="line">      <span class="string">actions</span> <span class="string">=</span> [<span class="string">&quot;Microsoft.Network/virtualNetworks/subnets/action&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">resource</span> <span class="string">&quot;azurerm_subnet_network_security_group_association&quot;</span> <span class="string">&quot;nsg-association&quot;</span> &#123;</span><br><span class="line">  <span class="string">count</span>                     <span class="string">=</span> <span class="string">var.use_existing_vnet_and_subnet</span> <span class="string">?</span> <span class="attr">0 :</span> <span class="number">1</span></span><br><span class="line">  <span class="string">subnet_id</span>                 <span class="string">=</span> <span class="string">azurerm_subnet.snet</span>[<span class="number">0</span>]<span class="string">.id</span></span><br><span class="line">  <span class="string">network_security_group_id</span> <span class="string">=</span> <span class="string">azurerm_network_security_group.nsg</span>[<span class="number">0</span>]<span class="string">.id</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">resource</span> <span class="string">&quot;azurerm_app_service_environment_v3&quot;</span> <span class="string">&quot;asev3&quot;</span> &#123;</span><br><span class="line">  <span class="string">name</span>                <span class="string">=</span> <span class="string">var.ase_name</span></span><br><span class="line">  <span class="string">resource_group_name</span> <span class="string">=</span> <span class="string">azurerm_resource_group.rg.name</span></span><br><span class="line">  <span class="string">subnet_id</span>           <span class="string">=</span> <span class="string">var.use_existing_vnet_and_subnet</span> <span class="string">?</span> <span class="string">azurerm_subnet.snet-delegation</span>[<span class="number">0</span>]<span class="string">.id</span> <span class="string">:</span> <span class="string">azurerm_subnet.snet</span>[<span class="number">0</span>]<span class="string">.id</span></span><br><span class="line"></span><br><span class="line">  <span class="string">dedicated_host_count</span>         <span class="string">=</span> <span class="string">var.dedicated_host_count</span> <span class="string">&gt;=</span> <span class="number">2</span> <span class="string">?</span> <span class="attr">var.dedicated_host_count :</span> <span class="literal">null</span></span><br><span class="line">  <span class="string">zone_redundant</span>               <span class="string">=</span> <span class="string">var.zone_redundant</span> <span class="string">?</span> <span class="attr">var.zone_redundant :</span> <span class="literal">null</span></span><br><span class="line">  <span class="string">internal_load_balancing_mode</span> <span class="string">=</span> <span class="string">var.internal_load_balancing_mode</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">resource</span> <span class="string">&quot;azurerm_private_dns_zone&quot;</span> <span class="string">&quot;zone&quot;</span> &#123;</span><br><span class="line">  <span class="string">count</span>               <span class="string">=</span> <span class="string">(var.create_private_dns</span> <span class="string">&amp;&amp;</span> <span class="string">var.internal_load_balancing_mode</span> <span class="string">==</span> <span class="string">&quot;Web, Publishing&quot;</span><span class="string">)</span> <span class="string">?</span> <span class="attr">1 :</span> <span class="number">0</span></span><br><span class="line">  <span class="string">name</span>                <span class="string">=</span> <span class="string">azurerm_app_service_environment_v3.asev3.dns_suffix</span></span><br><span class="line">  <span class="string">resource_group_name</span> <span class="string">=</span> <span class="string">azurerm_resource_group.rg.name</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">resource</span> <span class="string">&quot;azurerm_private_dns_a_record&quot;</span> <span class="string">&quot;a-wildcard&quot;</span> &#123;</span><br><span class="line">  <span class="string">count</span>               <span class="string">=</span> <span class="string">(var.create_private_dns</span> <span class="string">&amp;&amp;</span> <span class="string">var.internal_load_balancing_mode</span> <span class="string">==</span> <span class="string">&quot;Web, Publishing&quot;</span><span class="string">)</span> <span class="string">?</span> <span class="attr">1 :</span> <span class="number">0</span></span><br><span class="line">  <span class="string">name</span>                <span class="string">=</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">  <span class="string">zone_name</span>           <span class="string">=</span> <span class="string">azurerm_private_dns_zone.zone</span>[<span class="number">0</span>]<span class="string">.name</span></span><br><span class="line">  <span class="string">resource_group_name</span> <span class="string">=</span> <span class="string">azurerm_resource_group.rg.name</span></span><br><span class="line">  <span class="string">ttl</span>                 <span class="string">=</span> <span class="number">3600</span></span><br><span class="line">  <span class="string">records</span>             <span class="string">=</span> <span class="string">azurerm_app_service_environment_v3.asev3.internal_inbound_ip_addresses</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">resource</span> <span class="string">&quot;azurerm_private_dns_a_record&quot;</span> <span class="string">&quot;a-scm&quot;</span> &#123;</span><br><span class="line">  <span class="string">count</span>               <span class="string">=</span> <span class="string">(var.create_private_dns</span> <span class="string">&amp;&amp;</span> <span class="string">var.internal_load_balancing_mode</span> <span class="string">==</span> <span class="string">&quot;Web, Publishing&quot;</span><span class="string">)</span> <span class="string">?</span> <span class="attr">1 :</span> <span class="number">0</span></span><br><span class="line">  <span class="string">name</span>                <span class="string">=</span> <span class="string">&quot;*.scm&quot;</span></span><br><span class="line">  <span class="string">zone_name</span>           <span class="string">=</span> <span class="string">azurerm_private_dns_zone.zone</span>[<span class="number">0</span>]<span class="string">.name</span></span><br><span class="line">  <span class="string">resource_group_name</span> <span class="string">=</span> <span class="string">azurerm_resource_group.rg.name</span></span><br><span class="line">  <span class="string">ttl</span>                 <span class="string">=</span> <span class="number">3600</span></span><br><span class="line">  <span class="string">records</span>             <span class="string">=</span> <span class="string">azurerm_app_service_environment_v3.asev3.internal_inbound_ip_addresses</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">resource</span> <span class="string">&quot;azurerm_private_dns_a_record&quot;</span> <span class="string">&quot;a-at&quot;</span> &#123;</span><br><span class="line">  <span class="string">count</span>               <span class="string">=</span> <span class="string">(var.create_private_dns</span> <span class="string">&amp;&amp;</span> <span class="string">var.internal_load_balancing_mode</span> <span class="string">==</span> <span class="string">&quot;Web, Publishing&quot;</span><span class="string">)</span> <span class="string">?</span> <span class="attr">1 :</span> <span class="number">0</span></span><br><span class="line">  <span class="string">name</span>                <span class="string">=</span> <span class="string">&quot;@&quot;</span></span><br><span class="line">  <span class="string">zone_name</span>           <span class="string">=</span> <span class="string">azurerm_private_dns_zone.zone</span>[<span class="number">0</span>]<span class="string">.name</span></span><br><span class="line">  <span class="string">resource_group_name</span> <span class="string">=</span> <span class="string">azurerm_resource_group.rg.name</span></span><br><span class="line">  <span class="string">ttl</span>                 <span class="string">=</span> <span class="number">3600</span></span><br><span class="line">  <span class="string">records</span>             <span class="string">=</span> <span class="string">azurerm_app_service_environment_v3.asev3.internal_inbound_ip_addresses</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Argument-Reference"><a href="#Argument-Reference" class="headerlink" title="Argument Reference"></a>Argument Reference</h2><ul>
<li><p><code>ase_resource_group_name</code> - (Required) The name of the Resource Group where the App Service Environment exists. </p>
</li>
<li><p><code>location</code> - (Required) The location of the Resource Group where the App Service Environment exists. </p>
</li>
<li><p><code>use_existing_vnet_and_subnet</code> - (Required) Set to <code>true</code> if the ASEv3 will be resided in an existing VNet and subnet.</p>
</li>
<li><p><code>vnet_resource_group_name</code> - (Optional) The name of the Resource Group where the existing VNet exists. Only required if <code>use_existing_vnet_and_subnet</code> set to <code>true</code>. </p>
</li>
<li><p><code>virtual_network_name</code> - (Required) The name of the VNet where the App Service Environment exists.</p>
</li>
<li><p><code>vnet_address_prefixes</code> - (Optional) The address spaces of VNet where the App Service Environment exists. Only required if <code>use_existing_vnet_and_subnet</code> set to <code>false</code>.</p>
</li>
<li><p><code>subnet_name</code> - (Required) The name of the subnet where the App Service Environment exists.</p>
</li>
<li><p><code>subnet_address_prefixes</code> - (Optional)  The address spaces of subnet where the App Service Environment exists. Only required if <code>use_existing_vnet_and_subnet</code> set to <code>false</code>.</p>
</li>
<li><p><code>ase_name</code> - (Required) The name of the App Service Environment. This is a global Azure resource name should be unique.</p>
</li>
<li><p><code>dedicated_host_count</code> - (Optional) This ASEv3 should use dedicated Hosts. Possible vales are <code>2</code>. Changing this forces a new resource to be created. You can only set either <code>dedicated_host_count</code> or <code>zone_redundant</code> but not both.</p>
</li>
<li><p><code>zone_redundant</code> - (Optional) Set to <code>true</code> to deplyed ASEv3 with availability zones supported. Zonal ASEs can be deployed in some regions, you can refer to <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/app-service/environment/zone-redundancy">Availability Zone support for App Service Environments</a>. You can only set either <code>dedicated_host_count</code> or <code>zone_redundant</code> but not both.</p>
</li>
</ul>
<p>~&gt; <strong>NOTE:</strong> Setting this value will provision 2 Physical Hosts for your App Service Environment V3, this is done at additional cost, please be aware of the pricing commitment in the <a target="_blank" rel="noopener" href="https://techcommunity.microsoft.com/t5/apps-on-azure/announcing-app-service-environment-v3-ga/ba-p/2517990">General Availability Notes</a></p>
<ul>
<li><p><code>create_private_dns</code> - (Required) Set to <code>true</code> to create private dns zone after ASEv3 had been created. Only available for internal load balancing mode ASE.</p>
</li>
<li><p><code>internal_load_balancing_mode</code> - (Required) Specifies which endpoints to serve internally in the Virtual Network for the App Service Environment. Possible values are <code>None</code> (for an External VIP Type), and <code>&quot;Web, Publishing&quot;</code> (for an Internal VIP Type). Defaults to <code>None</code>.</p>
</li>
<li><p><code>network_security_group_name</code> - (Optional) The network security group name of the subnet where App Service Environment exists.</p>
</li>
<li><p><code>network_security_group_security_rules</code> - (Optional) The network security group rules of the subnet network security group where App Service Environment exists.</p>
</li>
</ul>
<p>~&gt; <strong>NOTE</strong> a /24 or larger CIDR is required. Once associated with an ASE, this size cannot be changed.</p>
<p>~&gt; <strong>NOTE:</strong> This Subnet requires a delegation to <code>Microsoft.Web/hostingEnvironments</code> as detailed in the example above.    </p>
<hr>
<h2 id="Attribute-Reference"><a href="#Attribute-Reference" class="headerlink" title="Attribute Reference"></a>Attribute Reference</h2><ul>
<li><p><code>allow_new_private_endpoint_connections</code> - New Private Endpoint Connections be allowed. Defaults to <code>true</code>.</p>
</li>
<li><p><code>dns_suffix</code> - the DNS suffix for this App Service Environment V3. </p>
</li>
<li><p><code>external_inbound_ip_addresses</code> - The external outbound IP addresses of the App Service Environment V3.</p>
</li>
<li><p><code>id</code> - The ID of the App Service Environment.</p>
</li>
<li><p><code>inbound_network_dependencies</code> - An inbound Network Dependencies block as defined below.</p>
</li>
<li><p><code>internal_inbound_ip_addresses</code> - The internal outbound IP addresses of the App Service Environment V3.</p>
</li>
<li><p><code>internal_load_balancing_mode</code> - Endpoints to serve internally in the Virtual Network for the App Service Environment. Possible values are <code>None</code> (for an External VIP Type), and <code>&quot;Web, Publishing&quot;</code> (for an Internal VIP Type). Defaults to <code>None</code>.</p>
</li>
<li><p><code>ip_ssl_address_count</code> - The number of IP SSL addresses reserved for the App Service Environment V3.</p>
</li>
<li><p><code>linux_outbound_ip_addresses</code> - Outbound addresses of Linux based Apps in this App Service Environment V3</p>
</li>
<li><p><code>location</code> - The location where the App Service Environment exists.</p>
</li>
<li><p><code>name</code> - The name of the App Service Environment V3.</p>
</li>
<li><p><code>pricing_tier</code> - Pricing tier for the front end instances.</p>
</li>
<li><p><code>resource_group_name</code> - The name of the Resource Group where the App Service Environment exists.</p>
</li>
<li><p><code>subnet_id</code> - The ID of the Subnet which the App Service Environment connected.</p>
</li>
<li><p><code>windows_outbound_ip_addresses</code> - Outbound addresses of Windows based Apps in this App Service Environment V3. </p>
</li>
<li><p><code>zone_redundant</code> - ASEv3 deployed in availability zones or not.</p>
</li>
</ul>
<h2 id="Example-Usage-Internal-load-balance-ASEv3"><a href="#Example-Usage-Internal-load-balance-ASEv3" class="headerlink" title="Example Usage - Internal load balance ASEv3"></a>Example Usage - Internal load balance ASEv3</h2><p>To create an ASEv3 ILB environment, you can edit the <code>internal_load_balancing_mode</code>=<code>&quot;Web, Publishing&quot;</code>, <code>dedicated_host_count</code> and <code>zone_redundant</code> variables in the <em>terraform.tfvars</em> file.</p>
<h3 id="Edit-the-variable-file"><a href="#Edit-the-variable-file" class="headerlink" title="Edit the variable file"></a>Edit the variable file</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># terraform.tfvars</span></span><br><span class="line"><span class="string">ase_resource_group_name</span>               <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-ilb-demo&quot;</span></span><br><span class="line"><span class="string">use_existing_vnet_and_subnet</span>          <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">vnet_resource_group_name</span>              <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-demo&quot;</span></span><br><span class="line"><span class="string">virtual_network_name</span>                  <span class="string">=</span> <span class="string">&quot;vnet-spoke-asev3&quot;</span></span><br><span class="line"><span class="string">location</span>                              <span class="string">=</span> <span class="string">&quot;West US 2&quot;</span></span><br><span class="line"><span class="string">vnet_address_prefixes</span>                 <span class="string">=</span> [<span class="string">&quot;172.16.0.0/16&quot;</span>]</span><br><span class="line"><span class="string">subnet_name</span>                           <span class="string">=</span> <span class="string">&quot;snet-asev3&quot;</span></span><br><span class="line"><span class="string">subnet_address_prefixes</span>               <span class="string">=</span> [<span class="string">&quot;172.16.0.0/24&quot;</span>]</span><br><span class="line"><span class="string">ase_name</span>                              <span class="string">=</span> <span class="string">&quot;asev3-20211005&quot;</span></span><br><span class="line"><span class="string">dedicated_host_count</span>                  <span class="string">=</span> <span class="number">0</span></span><br><span class="line"><span class="string">zone_redundant</span>                        <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">create_private_dns</span>                    <span class="string">=</span> <span class="literal">true</span></span><br><span class="line"><span class="string">internal_load_balancing_mode</span>          <span class="string">=</span> <span class="string">&quot;Web, Publishing&quot;</span></span><br><span class="line"><span class="string">network_security_group_name</span>           <span class="string">=</span> <span class="string">&quot;nsg-asev3&quot;</span></span><br><span class="line"><span class="string">network_security_group_security_rules</span> <span class="string">=</span> []		</span><br></pre></td></tr></table></figure>

<h3 id="Apply-terraform"><a href="#Apply-terraform" class="headerlink" title="Apply terraform"></a>Apply terraform</h3><p>Run the following command to provision ASEv3 ILB environment.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">terraform init</span><br><span class="line"></span><br><span class="line">terraform plan</span><br><span class="line"></span><br><span class="line">terraform apply -auto-approve</span><br></pre></td></tr></table></figure>

<h2 id="Example-Usage-External-load-balance-ASEv3"><a href="#Example-Usage-External-load-balance-ASEv3" class="headerlink" title="Example Usage - External load balance ASEv3"></a>Example Usage - External load balance ASEv3</h2><p>To create an ASEv3 ELB environment, you can edit the <code>internal_load_balancing_mode</code>=<code>&quot;None&quot;</code>, <code>dedicated_host_count</code> and <code>zone_redundant</code> variables in the <em>terraform.tfvars</em> file.</p>
<h3 id="Edit-the-variable-file-1"><a href="#Edit-the-variable-file-1" class="headerlink" title="Edit the variable file"></a>Edit the variable file</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># terraform.tfvars</span></span><br><span class="line"><span class="string">ase_resource_group_name</span>               <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-ilb-demo&quot;</span></span><br><span class="line"><span class="string">use_existing_vnet_and_subnet</span>          <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">vnet_resource_group_name</span>              <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-demo&quot;</span></span><br><span class="line"><span class="string">virtual_network_name</span>                  <span class="string">=</span> <span class="string">&quot;vnet-spoke-asev3&quot;</span></span><br><span class="line"><span class="string">location</span>                              <span class="string">=</span> <span class="string">&quot;West US 2&quot;</span></span><br><span class="line"><span class="string">vnet_address_prefixes</span>                 <span class="string">=</span> [<span class="string">&quot;172.16.0.0/16&quot;</span>]</span><br><span class="line"><span class="string">subnet_name</span>                           <span class="string">=</span> <span class="string">&quot;snet-asev3&quot;</span></span><br><span class="line"><span class="string">subnet_address_prefixes</span>               <span class="string">=</span> [<span class="string">&quot;172.16.0.0/24&quot;</span>]</span><br><span class="line"><span class="string">ase_name</span>                              <span class="string">=</span> <span class="string">&quot;asev3-20211005&quot;</span></span><br><span class="line"><span class="string">dedicated_host_count</span>                  <span class="string">=</span> <span class="number">0</span></span><br><span class="line"><span class="string">zone_redundant</span>                        <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">create_private_dns</span>                    <span class="string">=</span> <span class="literal">true</span></span><br><span class="line"><span class="string">internal_load_balancing_mode</span>          <span class="string">=</span> <span class="string">&quot;None&quot;</span></span><br><span class="line"><span class="string">network_security_group_name</span>           <span class="string">=</span> <span class="string">&quot;nsg-asev3&quot;</span></span><br><span class="line"><span class="string">network_security_group_security_rules</span> <span class="string">=</span> []		</span><br></pre></td></tr></table></figure>

<h3 id="Apply-terraform-1"><a href="#Apply-terraform-1" class="headerlink" title="Apply terraform"></a>Apply terraform</h3><p>Run the following command to provision ASEv3 ELB environment.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">terraform init</span><br><span class="line"></span><br><span class="line">terraform plan</span><br><span class="line"></span><br><span class="line">terraform apply -auto-approve</span><br></pre></td></tr></table></figure>
<h2 id="Example-Usage-Internal-load-balance-ASEv3-with-AZ-support"><a href="#Example-Usage-Internal-load-balance-ASEv3-with-AZ-support" class="headerlink" title="Example Usage - Internal load balance ASEv3 with AZ support"></a>Example Usage - Internal load balance ASEv3 with AZ support</h2><p>To create an ASEv3 ILB environment with AZ support, you can edit the <code>internal_load_balancing_mode</code>=<code>&quot;Web, Publishing&quot;</code>, <code>dedicated_host_count</code> and <code>zone_redundant</code>=<code>true</code> variables in the <em>terraform.tfvars</em> file.</p>
<p>Note: You can only use either <code>dedicated_host_count</code> or <code>zone_redundant</code> attribute, you cannot use both.</p>
<h3 id="Edit-the-variable-file-2"><a href="#Edit-the-variable-file-2" class="headerlink" title="Edit the variable file"></a>Edit the variable file</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># terraform.tfvars</span></span><br><span class="line"><span class="string">ase_resource_group_name</span>               <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-ilb-demo&quot;</span></span><br><span class="line"><span class="string">use_existing_vnet_and_subnet</span>          <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">vnet_resource_group_name</span>              <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-demo&quot;</span></span><br><span class="line"><span class="string">virtual_network_name</span>                  <span class="string">=</span> <span class="string">&quot;vnet-spoke-asev3&quot;</span></span><br><span class="line"><span class="string">location</span>                              <span class="string">=</span> <span class="string">&quot;West US 2&quot;</span></span><br><span class="line"><span class="string">vnet_address_prefixes</span>                 <span class="string">=</span> [<span class="string">&quot;172.16.0.0/16&quot;</span>]</span><br><span class="line"><span class="string">subnet_name</span>                           <span class="string">=</span> <span class="string">&quot;snet-asev3&quot;</span></span><br><span class="line"><span class="string">subnet_address_prefixes</span>               <span class="string">=</span> [<span class="string">&quot;172.16.0.0/24&quot;</span>]</span><br><span class="line"><span class="string">ase_name</span>                              <span class="string">=</span> <span class="string">&quot;asev3-20211005&quot;</span></span><br><span class="line"><span class="string">dedicated_host_count</span>                  <span class="string">=</span> <span class="number">0</span></span><br><span class="line"><span class="string">zone_redundant</span>                        <span class="string">=</span> <span class="literal">true</span></span><br><span class="line"><span class="string">create_private_dns</span>                    <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">internal_load_balancing_mode</span>          <span class="string">=</span> <span class="string">&quot;Web, Publishing&quot;</span></span><br><span class="line"><span class="string">network_security_group_name</span>           <span class="string">=</span> <span class="string">&quot;nsg-asev3&quot;</span></span><br><span class="line"><span class="string">network_security_group_security_rules</span> <span class="string">=</span> []		</span><br></pre></td></tr></table></figure>

<h3 id="Apply-terraform-2"><a href="#Apply-terraform-2" class="headerlink" title="Apply terraform"></a>Apply terraform</h3><p>Run the following command to provision ASEv3 ILB with AZ support environment.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">terraform init</span><br><span class="line"></span><br><span class="line">terraform plan</span><br><span class="line"></span><br><span class="line">terraform apply -auto-approve</span><br></pre></td></tr></table></figure>
<h2 id="Example-Usage-External-load-balance-ASEv3-with-AZ-support"><a href="#Example-Usage-External-load-balance-ASEv3-with-AZ-support" class="headerlink" title="Example Usage - External load balance ASEv3 with AZ support"></a>Example Usage - External load balance ASEv3 with AZ support</h2><p>To create an ASEv3 ELB environment with AZ support, you can edit the <code>internal_load_balancing_mode</code>=<code>&quot;None&quot;</code>, <code>dedicated_host_count</code> and <code>zone_redundant</code>=<code>true</code> variables in the <em>terraform.tfvars</em> file.</p>
<p>Note: You can only use either <code>dedicated_host_count</code> or <code>zone_redundant</code> attribute, you cannot use both.</p>
<h3 id="Edit-the-variable-file-3"><a href="#Edit-the-variable-file-3" class="headerlink" title="Edit the variable file"></a>Edit the variable file</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># terraform.tfvars</span></span><br><span class="line"><span class="string">ase_resource_group_name</span>               <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-ilb-demo&quot;</span></span><br><span class="line"><span class="string">use_existing_vnet_and_subnet</span>          <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">vnet_resource_group_name</span>              <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-demo&quot;</span></span><br><span class="line"><span class="string">virtual_network_name</span>                  <span class="string">=</span> <span class="string">&quot;vnet-spoke-asev3&quot;</span></span><br><span class="line"><span class="string">location</span>                              <span class="string">=</span> <span class="string">&quot;West US 2&quot;</span></span><br><span class="line"><span class="string">vnet_address_prefixes</span>                 <span class="string">=</span> [<span class="string">&quot;172.16.0.0/16&quot;</span>]</span><br><span class="line"><span class="string">subnet_name</span>                           <span class="string">=</span> <span class="string">&quot;snet-asev3&quot;</span></span><br><span class="line"><span class="string">subnet_address_prefixes</span>               <span class="string">=</span> [<span class="string">&quot;172.16.0.0/24&quot;</span>]</span><br><span class="line"><span class="string">ase_name</span>                              <span class="string">=</span> <span class="string">&quot;asev3-20211005&quot;</span></span><br><span class="line"><span class="string">dedicated_host_count</span>                  <span class="string">=</span> <span class="number">0</span></span><br><span class="line"><span class="string">zone_redundant</span>                        <span class="string">=</span> <span class="literal">true</span></span><br><span class="line"><span class="string">create_private_dns</span>                    <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">internal_load_balancing_mode</span>          <span class="string">=</span> <span class="string">&quot;None&quot;</span></span><br><span class="line"><span class="string">network_security_group_name</span>           <span class="string">=</span> <span class="string">&quot;nsg-asev3&quot;</span></span><br><span class="line"><span class="string">network_security_group_security_rules</span> <span class="string">=</span> []		</span><br></pre></td></tr></table></figure>

<h3 id="Apply-terraform-3"><a href="#Apply-terraform-3" class="headerlink" title="Apply terraform"></a>Apply terraform</h3><p>Run the following command to provision ASEv3 ELB with AZ support environment.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">terraform init</span><br><span class="line"></span><br><span class="line">terraform plan</span><br><span class="line"></span><br><span class="line">terraform apply -auto-approve</span><br></pre></td></tr></table></figure>
<h2 id="Example-Usage-Internal-load-balance-ASEv3-on-dedicated-hosts"><a href="#Example-Usage-Internal-load-balance-ASEv3-on-dedicated-hosts" class="headerlink" title="Example Usage - Internal load balance ASEv3 on dedicated hosts"></a>Example Usage - Internal load balance ASEv3 on dedicated hosts</h2><p>To create an ASEv3 ILB environment on dedicated hosts, you can edit the <code>internal_load_balancing_mode</code>=<code>&quot;Web, Publishing&quot;</code>, <code>dedicated_host_count=2</code> and <code>zone_redundant</code> variables in the <em>terraform.tfvars</em> file.</p>
<p>Note: You can only use either <code>dedicated_host_count</code> or <code>zone_redundant</code> attribute, you cannot use both.</p>
<h3 id="Edit-the-variable-file-4"><a href="#Edit-the-variable-file-4" class="headerlink" title="Edit the variable file"></a>Edit the variable file</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># terraform.tfvars</span></span><br><span class="line"><span class="string">ase_resource_group_name</span>               <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-ilb-demo&quot;</span></span><br><span class="line"><span class="string">use_existing_vnet_and_subnet</span>          <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">vnet_resource_group_name</span>              <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-demo&quot;</span></span><br><span class="line"><span class="string">virtual_network_name</span>                  <span class="string">=</span> <span class="string">&quot;vnet-spoke-asev3&quot;</span></span><br><span class="line"><span class="string">location</span>                              <span class="string">=</span> <span class="string">&quot;West US 2&quot;</span></span><br><span class="line"><span class="string">vnet_address_prefixes</span>                 <span class="string">=</span> [<span class="string">&quot;172.16.0.0/16&quot;</span>]</span><br><span class="line"><span class="string">subnet_name</span>                           <span class="string">=</span> <span class="string">&quot;snet-asev3&quot;</span></span><br><span class="line"><span class="string">subnet_address_prefixes</span>               <span class="string">=</span> [<span class="string">&quot;172.16.0.0/24&quot;</span>]</span><br><span class="line"><span class="string">ase_name</span>                              <span class="string">=</span> <span class="string">&quot;asev3-20211005&quot;</span></span><br><span class="line"><span class="string">dedicated_host_count</span>                  <span class="string">=</span> <span class="number">2</span></span><br><span class="line"><span class="string">zone_redundant</span>                        <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">create_private_dns</span>                    <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">internal_load_balancing_mode</span>          <span class="string">=</span> <span class="string">&quot;Web, Publishing&quot;</span></span><br><span class="line"><span class="string">network_security_group_name</span>           <span class="string">=</span> <span class="string">&quot;nsg-asev3&quot;</span></span><br><span class="line"><span class="string">network_security_group_security_rules</span> <span class="string">=</span> []		</span><br></pre></td></tr></table></figure>

<h3 id="Apply-terraform-4"><a href="#Apply-terraform-4" class="headerlink" title="Apply terraform"></a>Apply terraform</h3><p>Run the following command to provision ASEv3 ILB environment.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">terraform init</span><br><span class="line"></span><br><span class="line">terraform plan</span><br><span class="line"></span><br><span class="line">terraform apply -auto-approve</span><br></pre></td></tr></table></figure>
<h2 id="Example-Usage-External-load-balance-ASEv3-on-dedicated-hosts"><a href="#Example-Usage-External-load-balance-ASEv3-on-dedicated-hosts" class="headerlink" title="Example Usage - External load balance ASEv3 on dedicated hosts"></a>Example Usage - External load balance ASEv3 on dedicated hosts</h2><p>To create an ASEv3 ELB environment on dedicated hosts, you can edit the <code>internal_load_balancing_mode</code>=<code>&quot;None&quot;</code>, <code>dedicated_host_count=2</code> and <code>zone_redundant</code> variables in the <em>terraform.tfvars</em> file.</p>
<p>Note: You can only use either <code>dedicated_host_count</code> or <code>zone_redundant</code> attribute, you cannot use both.</p>
<h3 id="Edit-the-variable-file-5"><a href="#Edit-the-variable-file-5" class="headerlink" title="Edit the variable file"></a>Edit the variable file</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># terraform.tfvars</span></span><br><span class="line"><span class="string">ase_resource_group_name</span>               <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-ilb-demo&quot;</span></span><br><span class="line"><span class="string">use_existing_vnet_and_subnet</span>          <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">vnet_resource_group_name</span>              <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-demo&quot;</span></span><br><span class="line"><span class="string">virtual_network_name</span>                  <span class="string">=</span> <span class="string">&quot;vnet-spoke-asev3&quot;</span></span><br><span class="line"><span class="string">location</span>                              <span class="string">=</span> <span class="string">&quot;West US 2&quot;</span></span><br><span class="line"><span class="string">vnet_address_prefixes</span>                 <span class="string">=</span> [<span class="string">&quot;172.16.0.0/16&quot;</span>]</span><br><span class="line"><span class="string">subnet_name</span>                           <span class="string">=</span> <span class="string">&quot;snet-asev3&quot;</span></span><br><span class="line"><span class="string">subnet_address_prefixes</span>               <span class="string">=</span> [<span class="string">&quot;172.16.0.0/24&quot;</span>]</span><br><span class="line"><span class="string">ase_name</span>                              <span class="string">=</span> <span class="string">&quot;asev3-20211005&quot;</span></span><br><span class="line"><span class="string">dedicated_host_count</span>                  <span class="string">=</span> <span class="number">2</span></span><br><span class="line"><span class="string">zone_redundant</span>                        <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">create_private_dns</span>                    <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">internal_load_balancing_mode</span>          <span class="string">=</span> <span class="string">&quot;None&quot;</span></span><br><span class="line"><span class="string">network_security_group_name</span>           <span class="string">=</span> <span class="string">&quot;nsg-asev3&quot;</span></span><br><span class="line"><span class="string">network_security_group_security_rules</span> <span class="string">=</span> []		</span><br></pre></td></tr></table></figure>

<h3 id="Apply-terraform-5"><a href="#Apply-terraform-5" class="headerlink" title="Apply terraform"></a>Apply terraform</h3><p>Run the following command to provision ASEv3 ILB environment.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">terraform init</span><br><span class="line"></span><br><span class="line">terraform plan</span><br><span class="line"></span><br><span class="line">terraform apply -auto-approve</span><br></pre></td></tr></table></figure>

<h2 id="Example-Usage-Internal-load-balance-ASEv3-on-an-existing-VNet-and-subnet"><a href="#Example-Usage-Internal-load-balance-ASEv3-on-an-existing-VNet-and-subnet" class="headerlink" title="Example Usage - Internal load balance ASEv3 on an existing VNet and subnet"></a>Example Usage - Internal load balance ASEv3 on an existing VNet and subnet</h2><p>To create an ASEv3 ILB environment on an existing VNet and subnet, you can edit the <code>use_existing_vnet_and_subnet</code>=<code>true</code>, <code>vnet_resource_group_name</code>,<code>virtual_network_name</code> and <code>subnet_name</code> variables in the <em>terraform.tfvars</em> file.</p>
<h3 id="Edit-the-variable-file-6"><a href="#Edit-the-variable-file-6" class="headerlink" title="Edit the variable file"></a>Edit the variable file</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># terraform.tfvars</span></span><br><span class="line"><span class="string">ase_resource_group_name</span>               <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-ilb-demo&quot;</span></span><br><span class="line"><span class="string">use_existing_vnet_and_subnet</span>          <span class="string">=</span> <span class="literal">true</span></span><br><span class="line"><span class="string">vnet_resource_group_name</span>              <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-demo&quot;</span></span><br><span class="line"><span class="string">virtual_network_name</span>                  <span class="string">=</span> <span class="string">&quot;vnet-spoke-asev3&quot;</span></span><br><span class="line"><span class="string">location</span>                              <span class="string">=</span> <span class="string">&quot;West US 2&quot;</span></span><br><span class="line"><span class="string">vnet_address_prefixes</span>                 <span class="string">=</span> [<span class="string">&quot;172.16.0.0/16&quot;</span>]</span><br><span class="line"><span class="string">subnet_name</span>                           <span class="string">=</span> <span class="string">&quot;snet-asev3&quot;</span></span><br><span class="line"><span class="string">subnet_address_prefixes</span>               <span class="string">=</span> [<span class="string">&quot;172.16.0.0/24&quot;</span>]</span><br><span class="line"><span class="string">ase_name</span>                              <span class="string">=</span> <span class="string">&quot;asev3-20211005&quot;</span></span><br><span class="line"><span class="string">dedicated_host_count</span>                  <span class="string">=</span> <span class="number">0</span></span><br><span class="line"><span class="string">zone_redundant</span>                        <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">create_private_dns</span>                    <span class="string">=</span> <span class="literal">true</span></span><br><span class="line"><span class="string">internal_load_balancing_mode</span>          <span class="string">=</span> <span class="string">&quot;Web, Publishing&quot;</span></span><br><span class="line"><span class="string">network_security_group_name</span>           <span class="string">=</span> <span class="string">&quot;nsg-asev3&quot;</span></span><br><span class="line"><span class="string">network_security_group_security_rules</span> <span class="string">=</span> []		</span><br></pre></td></tr></table></figure>
<h3 id="Import-the-subnet-status-to-terraform"><a href="#Import-the-subnet-status-to-terraform" class="headerlink" title="Import the subnet status to terraform"></a>Import the subnet status to terraform</h3><p>When using the existing subnet, it is required to delegate subnet to <strong>Microsoft.Web/hostingEnvironments</strong>. To do the delegation on subnet, you will need to import the status to terraform by following command before apply the terraform plan: (where <code>snet-delegation</code> is the delegation subnet defined in your terraform template)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform import azurerm_subnet.snet-delegation /subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/yourvnetresourcegroup/providers/Microsoft.Network/virtualNetworks/yourventname/subnets/yoursubnetname</span><br></pre></td></tr></table></figure>

<h3 id="Apply-terraform-6"><a href="#Apply-terraform-6" class="headerlink" title="Apply terraform"></a>Apply terraform</h3><p>Run the following command to provision ASEv3 ILB environment.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">terraform init</span><br><span class="line"></span><br><span class="line">terraform plan</span><br><span class="line"></span><br><span class="line">terraform apply -auto-approve</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Sam Lin"
      src="/images/avator.png">
  <p class="site-author-name" itemprop="name">Sam Lin</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">5</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/samlin-msft" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;samlin-msft" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.linkedin.com/in/samlintw" title="Linkedin → https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;samlintw" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sam Lin</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  















  

  

</body>
</html>
