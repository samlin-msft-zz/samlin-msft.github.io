<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.samtreepay.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0RM9XRL718"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0RM9XRL718');
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="雜七雜八。有的沒的">
<meta property="og:url" content="https://blog.samtreepay.com/index.html">
<meta property="og:site_name" content="雜七雜八。有的沒的">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Sam Lin">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://blog.samtreepay.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>雜七雜八。有的沒的</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0RM9XRL718"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-0RM9XRL718');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">雜七雜八。有的沒的</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://blog.samtreepay.com/2021/10/05/create-an-asev3-from-terraform-templates/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avator.png">
      <meta itemprop="name" content="Sam Lin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雜七雜八。有的沒的">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/05/create-an-asev3-from-terraform-templates/" class="post-title-link" itemprop="url">Create an ASEv3 from terraform templates</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-10-05 00:30:56 / Modified: 02:45:55" itemprop="dateCreated datePublished" datetime="2021-10-05T00:30:56+08:00">2021-10-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/App-Service-Environment/" itemprop="url" rel="index"><span itemprop="name">App Service Environment</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2021/10/05/create-an-asev3-from-terraform-templates/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/10/05/create-an-asev3-from-terraform-templates/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>App Service Environment (ASE), provides an isolated and dedicated host environment for securely running app service at high scale. In ASEv3 there are 6 deployment types listed as following examples.  In each example, you will need to edit the variables in <code>terraform.tfvars</code>.</p>
<ul>
<li>ILB ASEv3 (<code>internal_load_balancing_mode</code> = <code>&quot;Web, Publishing&quot;</code> and <code>zone_redundant</code> = <code>false</code>)</li>
<li>ELB ASEv3 (<code>internal_load_balancing_mode</code> = <code>&quot;None&quot;</code> and <code>zone_redundant</code> = <code>false</code>)</li>
<li>ILB ASEv3 with AZ support (<code>internal_load_balancing_mode</code> = <code>&quot;Web, Publishing&quot;</code> and <code>zone_redundant</code> = <code>true</code>)</li>
<li>ELB ASEv3 with AZ support (<code>internal_load_balancing_mode</code> = <code>&quot;None&quot;</code> and <code>zone_redundant</code> = <code>true</code>)</li>
<li>ILB ASEv3 with dedicated hosts (<code>internal_load_balancing_mode</code> = <code>&quot;Web, Publishing&quot;</code> and <code>dedicated_host_count</code> = <code>2</code>)</li>
<li>ELB ASEv3 with dedicated hosts (<code>internal_load_balancing_mode</code> = <code>&quot;None&quot;</code> and <code>dedicated_host_count</code> = <code>2</code>)</li>
</ul>
<p>If you’re going to deploy an ASEv3 on an existing subnet, there is an import task you need to complete before apply the terraform.</p>
<h2 id="Terraform-and-Variables-templates"><a href="#Terraform-and-Variables-templates" class="headerlink" title="Terraform and Variables templates"></a>Terraform and Variables templates</h2><p>This example provisions an App Service Environment V3. Additional examples of how to use the azurerm_app_service_environment_v3 resource.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># variables.tf</span></span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;ase_resource_group_name&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span> <span class="string">=</span> <span class="string">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;use_existing_vnet_and_subnet&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span>    <span class="string">=</span> <span class="string">bool</span></span><br><span class="line">  <span class="string">default</span> <span class="string">=</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;vnet_resource_group_name&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span> <span class="string">=</span> <span class="string">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;virtual_network_name&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span> <span class="string">=</span> <span class="string">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;location&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span> <span class="string">=</span> <span class="string">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;vnet_address_prefixes&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span>    <span class="string">=</span> <span class="string">list(string)</span></span><br><span class="line">  <span class="string">default</span> <span class="string">=</span> [<span class="string">&quot;172.16.0.0/16&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;subnet_name&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span> <span class="string">=</span> <span class="string">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;subnet_address_prefixes&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span>    <span class="string">=</span> <span class="string">list(string)</span></span><br><span class="line">  <span class="string">default</span> <span class="string">=</span> [<span class="string">&quot;172.16.0.0/24&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;ase_name&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span> <span class="string">=</span> <span class="string">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;dedicated_host_count&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span>    <span class="string">=</span> <span class="string">number</span></span><br><span class="line">  <span class="string">default</span> <span class="string">=</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;zone_redundant&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span>    <span class="string">=</span> <span class="string">bool</span></span><br><span class="line">  <span class="string">default</span> <span class="string">=</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;create_private_dns&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span>    <span class="string">=</span> <span class="string">bool</span></span><br><span class="line">  <span class="string">default</span> <span class="string">=</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;internal_load_balancing_mode&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span>    <span class="string">=</span> <span class="string">string</span></span><br><span class="line">  <span class="string">default</span> <span class="string">=</span> <span class="string">&quot;Web, Publishing&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;network_security_group_name&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span> <span class="string">=</span> <span class="string">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">variable</span> <span class="string">&quot;network_security_group_security_rules&quot;</span> &#123;</span><br><span class="line">  <span class="string">type</span>    <span class="string">=</span> <span class="string">any</span></span><br><span class="line">  <span class="string">default</span> <span class="string">=</span> []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># main.tf</span></span><br><span class="line"><span class="string">terraform</span> &#123;</span><br><span class="line">  <span class="string">required_providers</span> &#123;</span><br><span class="line">    <span class="string">azurerm</span> <span class="string">=</span> &#123;</span><br><span class="line">      <span class="string">version</span> <span class="string">=</span> <span class="string">&quot;&gt;=2.76.0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">random</span> <span class="string">=</span> &#123;</span><br><span class="line">      <span class="string">version</span> <span class="string">=</span> <span class="string">&quot;3.1.0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">provider</span> <span class="string">&quot;azurerm&quot;</span> &#123;</span><br><span class="line">  <span class="string">features</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">resource</span> <span class="string">&quot;azurerm_resource_group&quot;</span> <span class="string">&quot;rg&quot;</span> &#123;</span><br><span class="line">  <span class="string">name</span>     <span class="string">=</span> <span class="string">var.ase_resource_group_name</span></span><br><span class="line">  <span class="string">location</span> <span class="string">=</span> <span class="string">var.location</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">data</span> <span class="string">&quot;azurerm_subnet&quot;</span> <span class="string">&quot;snet-exist&quot;</span> &#123;</span><br><span class="line">  <span class="string">count</span>                <span class="string">=</span> <span class="string">var.use_existing_vnet_and_subnet</span> <span class="string">?</span> <span class="attr">1 :</span> <span class="number">0</span></span><br><span class="line">  <span class="string">name</span>                 <span class="string">=</span> <span class="string">var.subnet_name</span></span><br><span class="line">  <span class="string">virtual_network_name</span> <span class="string">=</span> <span class="string">var.virtual_network_name</span></span><br><span class="line">  <span class="string">resource_group_name</span>  <span class="string">=</span> <span class="string">var.vnet_resource_group_name</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">resource</span> <span class="string">&quot;azurerm_network_security_group&quot;</span> <span class="string">&quot;nsg&quot;</span> &#123;</span><br><span class="line">  <span class="string">count</span>               <span class="string">=</span> <span class="string">var.use_existing_vnet_and_subnet</span> <span class="string">?</span> <span class="attr">0 :</span> <span class="number">1</span></span><br><span class="line">  <span class="string">name</span>                <span class="string">=</span> <span class="string">var.network_security_group_name</span></span><br><span class="line">  <span class="string">location</span>            <span class="string">=</span> <span class="string">azurerm_resource_group.rg.location</span></span><br><span class="line">  <span class="string">resource_group_name</span> <span class="string">=</span> <span class="string">azurerm_resource_group.rg.name</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">resource</span> <span class="string">&quot;azurerm_virtual_network&quot;</span> <span class="string">&quot;vnet&quot;</span> &#123;</span><br><span class="line">  <span class="string">count</span>               <span class="string">=</span> <span class="string">var.use_existing_vnet_and_subnet</span> <span class="string">?</span> <span class="attr">0 :</span> <span class="number">1</span></span><br><span class="line">  <span class="string">name</span>                <span class="string">=</span> <span class="string">var.virtual_network_name</span></span><br><span class="line">  <span class="string">location</span>            <span class="string">=</span> <span class="string">azurerm_resource_group.rg.location</span></span><br><span class="line">  <span class="string">resource_group_name</span> <span class="string">=</span> <span class="string">azurerm_resource_group.rg.name</span></span><br><span class="line">  <span class="string">address_space</span>       <span class="string">=</span> <span class="string">var.vnet_address_prefixes</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">resource</span> <span class="string">&quot;azurerm_subnet&quot;</span> <span class="string">&quot;snet&quot;</span> &#123;</span><br><span class="line">  <span class="string">count</span>                <span class="string">=</span> <span class="string">var.use_existing_vnet_and_subnet</span> <span class="string">?</span> <span class="attr">0 :</span> <span class="number">1</span></span><br><span class="line">  <span class="string">name</span>                 <span class="string">=</span> <span class="string">var.subnet_name</span></span><br><span class="line">  <span class="string">resource_group_name</span>  <span class="string">=</span> <span class="string">azurerm_resource_group.rg.name</span></span><br><span class="line">  <span class="string">virtual_network_name</span> <span class="string">=</span> <span class="string">azurerm_virtual_network.vnet</span>[<span class="number">0</span>]<span class="string">.name</span></span><br><span class="line">  <span class="string">address_prefixes</span>     <span class="string">=</span> <span class="string">var.subnet_address_prefixes</span></span><br><span class="line"></span><br><span class="line">  <span class="string">delegation</span> &#123;</span><br><span class="line">    <span class="string">name</span> <span class="string">=</span> <span class="string">&quot;Microsoft.Web.hostingEnvironments&quot;</span></span><br><span class="line">    <span class="string">service_delegation</span> &#123;</span><br><span class="line">      <span class="string">name</span>    <span class="string">=</span> <span class="string">&quot;Microsoft.Web/hostingEnvironments&quot;</span></span><br><span class="line">      <span class="string">actions</span> <span class="string">=</span> [<span class="string">&quot;Microsoft.Network/virtualNetworks/subnets/action&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">resource</span> <span class="string">&quot;azurerm_subnet&quot;</span> <span class="string">&quot;snet-delegation&quot;</span> &#123;</span><br><span class="line">  <span class="string">count</span>                <span class="string">=</span> <span class="string">var.use_existing_vnet_and_subnet</span> <span class="string">?</span> <span class="attr">1 :</span> <span class="number">0</span></span><br><span class="line">  <span class="string">name</span>                 <span class="string">=</span> <span class="string">var.subnet_name</span></span><br><span class="line">  <span class="string">virtual_network_name</span> <span class="string">=</span> <span class="string">var.virtual_network_name</span></span><br><span class="line">  <span class="string">resource_group_name</span>  <span class="string">=</span> <span class="string">var.vnet_resource_group_name</span></span><br><span class="line">  <span class="string">address_prefixes</span>     <span class="string">=</span> <span class="string">data.azurerm_subnet.snet-exist</span>[<span class="number">0</span>]<span class="string">.address_prefixes</span></span><br><span class="line"></span><br><span class="line">  <span class="string">delegation</span> &#123;</span><br><span class="line">    <span class="string">name</span> <span class="string">=</span> <span class="string">&quot;Microsoft.Web.hostingEnvironments&quot;</span></span><br><span class="line">    <span class="string">service_delegation</span> &#123;</span><br><span class="line">      <span class="string">name</span>    <span class="string">=</span> <span class="string">&quot;Microsoft.Web/hostingEnvironments&quot;</span></span><br><span class="line">      <span class="string">actions</span> <span class="string">=</span> [<span class="string">&quot;Microsoft.Network/virtualNetworks/subnets/action&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">resource</span> <span class="string">&quot;azurerm_subnet_network_security_group_association&quot;</span> <span class="string">&quot;nsg-association&quot;</span> &#123;</span><br><span class="line">  <span class="string">count</span>                     <span class="string">=</span> <span class="string">var.use_existing_vnet_and_subnet</span> <span class="string">?</span> <span class="attr">0 :</span> <span class="number">1</span></span><br><span class="line">  <span class="string">subnet_id</span>                 <span class="string">=</span> <span class="string">azurerm_subnet.snet</span>[<span class="number">0</span>]<span class="string">.id</span></span><br><span class="line">  <span class="string">network_security_group_id</span> <span class="string">=</span> <span class="string">azurerm_network_security_group.nsg</span>[<span class="number">0</span>]<span class="string">.id</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">resource</span> <span class="string">&quot;azurerm_app_service_environment_v3&quot;</span> <span class="string">&quot;asev3&quot;</span> &#123;</span><br><span class="line">  <span class="string">name</span>                <span class="string">=</span> <span class="string">var.ase_name</span></span><br><span class="line">  <span class="string">resource_group_name</span> <span class="string">=</span> <span class="string">azurerm_resource_group.rg.name</span></span><br><span class="line">  <span class="string">subnet_id</span>           <span class="string">=</span> <span class="string">var.use_existing_vnet_and_subnet</span> <span class="string">?</span> <span class="string">azurerm_subnet.snet-delegation</span>[<span class="number">0</span>]<span class="string">.id</span> <span class="string">:</span> <span class="string">azurerm_subnet.snet</span>[<span class="number">0</span>]<span class="string">.id</span></span><br><span class="line"></span><br><span class="line">  <span class="string">dedicated_host_count</span>         <span class="string">=</span> <span class="string">var.dedicated_host_count</span> <span class="string">&gt;=</span> <span class="number">2</span> <span class="string">?</span> <span class="attr">var.dedicated_host_count :</span> <span class="literal">null</span></span><br><span class="line">  <span class="string">zone_redundant</span>               <span class="string">=</span> <span class="string">var.zone_redundant</span> <span class="string">?</span> <span class="attr">var.zone_redundant :</span> <span class="literal">null</span></span><br><span class="line">  <span class="string">internal_load_balancing_mode</span> <span class="string">=</span> <span class="string">var.internal_load_balancing_mode</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">resource</span> <span class="string">&quot;azurerm_private_dns_zone&quot;</span> <span class="string">&quot;zone&quot;</span> &#123;</span><br><span class="line">  <span class="string">count</span>               <span class="string">=</span> <span class="string">(var.create_private_dns</span> <span class="string">&amp;&amp;</span> <span class="string">var.internal_load_balancing_mode</span> <span class="string">==</span> <span class="string">&quot;Web, Publishing&quot;</span><span class="string">)</span> <span class="string">?</span> <span class="attr">1 :</span> <span class="number">0</span></span><br><span class="line">  <span class="string">name</span>                <span class="string">=</span> <span class="string">azurerm_app_service_environment_v3.asev3.dns_suffix</span></span><br><span class="line">  <span class="string">resource_group_name</span> <span class="string">=</span> <span class="string">azurerm_resource_group.rg.name</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">resource</span> <span class="string">&quot;azurerm_private_dns_a_record&quot;</span> <span class="string">&quot;a-wildcard&quot;</span> &#123;</span><br><span class="line">  <span class="string">count</span>               <span class="string">=</span> <span class="string">(var.create_private_dns</span> <span class="string">&amp;&amp;</span> <span class="string">var.internal_load_balancing_mode</span> <span class="string">==</span> <span class="string">&quot;Web, Publishing&quot;</span><span class="string">)</span> <span class="string">?</span> <span class="attr">1 :</span> <span class="number">0</span></span><br><span class="line">  <span class="string">name</span>                <span class="string">=</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">  <span class="string">zone_name</span>           <span class="string">=</span> <span class="string">azurerm_private_dns_zone.zone</span>[<span class="number">0</span>]<span class="string">.name</span></span><br><span class="line">  <span class="string">resource_group_name</span> <span class="string">=</span> <span class="string">azurerm_resource_group.rg.name</span></span><br><span class="line">  <span class="string">ttl</span>                 <span class="string">=</span> <span class="number">3600</span></span><br><span class="line">  <span class="string">records</span>             <span class="string">=</span> <span class="string">azurerm_app_service_environment_v3.asev3.internal_inbound_ip_addresses</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">resource</span> <span class="string">&quot;azurerm_private_dns_a_record&quot;</span> <span class="string">&quot;a-scm&quot;</span> &#123;</span><br><span class="line">  <span class="string">count</span>               <span class="string">=</span> <span class="string">(var.create_private_dns</span> <span class="string">&amp;&amp;</span> <span class="string">var.internal_load_balancing_mode</span> <span class="string">==</span> <span class="string">&quot;Web, Publishing&quot;</span><span class="string">)</span> <span class="string">?</span> <span class="attr">1 :</span> <span class="number">0</span></span><br><span class="line">  <span class="string">name</span>                <span class="string">=</span> <span class="string">&quot;*.scm&quot;</span></span><br><span class="line">  <span class="string">zone_name</span>           <span class="string">=</span> <span class="string">azurerm_private_dns_zone.zone</span>[<span class="number">0</span>]<span class="string">.name</span></span><br><span class="line">  <span class="string">resource_group_name</span> <span class="string">=</span> <span class="string">azurerm_resource_group.rg.name</span></span><br><span class="line">  <span class="string">ttl</span>                 <span class="string">=</span> <span class="number">3600</span></span><br><span class="line">  <span class="string">records</span>             <span class="string">=</span> <span class="string">azurerm_app_service_environment_v3.asev3.internal_inbound_ip_addresses</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">resource</span> <span class="string">&quot;azurerm_private_dns_a_record&quot;</span> <span class="string">&quot;a-at&quot;</span> &#123;</span><br><span class="line">  <span class="string">count</span>               <span class="string">=</span> <span class="string">(var.create_private_dns</span> <span class="string">&amp;&amp;</span> <span class="string">var.internal_load_balancing_mode</span> <span class="string">==</span> <span class="string">&quot;Web, Publishing&quot;</span><span class="string">)</span> <span class="string">?</span> <span class="attr">1 :</span> <span class="number">0</span></span><br><span class="line">  <span class="string">name</span>                <span class="string">=</span> <span class="string">&quot;@&quot;</span></span><br><span class="line">  <span class="string">zone_name</span>           <span class="string">=</span> <span class="string">azurerm_private_dns_zone.zone</span>[<span class="number">0</span>]<span class="string">.name</span></span><br><span class="line">  <span class="string">resource_group_name</span> <span class="string">=</span> <span class="string">azurerm_resource_group.rg.name</span></span><br><span class="line">  <span class="string">ttl</span>                 <span class="string">=</span> <span class="number">3600</span></span><br><span class="line">  <span class="string">records</span>             <span class="string">=</span> <span class="string">azurerm_app_service_environment_v3.asev3.internal_inbound_ip_addresses</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Argument-Reference"><a href="#Argument-Reference" class="headerlink" title="Argument Reference"></a>Argument Reference</h2><ul>
<li><p><code>ase_resource_group_name</code> - (Required) The name of the Resource Group where the App Service Environment exists. </p>
</li>
<li><p><code>location</code> - (Required) The location of the Resource Group where the App Service Environment exists. </p>
</li>
<li><p><code>use_existing_vnet_and_subnet</code> - (Required) Set to <code>true</code> if the ASEv3 will be resided in an existing VNet and subnet.</p>
</li>
<li><p><code>vnet_resource_group_name</code> - (Optional) The name of the Resource Group where the existing VNet exists. Only required if <code>use_existing_vnet_and_subnet</code> set to <code>true</code>. </p>
</li>
<li><p><code>virtual_network_name</code> - (Required) The name of the VNet where the App Service Environment exists.</p>
</li>
<li><p><code>vnet_address_prefixes</code> - (Optional) The address spaces of VNet where the App Service Environment exists. Only required if <code>use_existing_vnet_and_subnet</code> set to <code>false</code>.</p>
</li>
<li><p><code>subnet_name</code> - (Required) The name of the subnet where the App Service Environment exists.</p>
</li>
<li><p><code>subnet_address_prefixes</code> - (Optional)  The address spaces of subnet where the App Service Environment exists. Only required if <code>use_existing_vnet_and_subnet</code> set to <code>false</code>.</p>
</li>
<li><p><code>ase_name</code> - (Required) The name of the App Service Environment. This is a global Azure resource name should be unique.</p>
</li>
<li><p><code>dedicated_host_count</code> - (Optional) This ASEv3 should use dedicated Hosts. Possible vales are <code>2</code>. Changing this forces a new resource to be created. You can only set either <code>dedicated_host_count</code> or <code>zone_redundant</code> but not both.</p>
</li>
<li><p><code>zone_redundant</code> - (Optional) Set to <code>true</code> to deplyed ASEv3 with availability zones supported. Zonal ASEs can be deployed in some regions, you can refer to <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/app-service/environment/zone-redundancy">Availability Zone support for App Service Environments</a>. You can only set either <code>dedicated_host_count</code> or <code>zone_redundant</code> but not both.</p>
</li>
</ul>
<p>~&gt; <strong>NOTE:</strong> Setting this value will provision 2 Physical Hosts for your App Service Environment V3, this is done at additional cost, please be aware of the pricing commitment in the <a target="_blank" rel="noopener" href="https://techcommunity.microsoft.com/t5/apps-on-azure/announcing-app-service-environment-v3-ga/ba-p/2517990">General Availability Notes</a></p>
<ul>
<li><p><code>create_private_dns</code> - (Required) Set to <code>true</code> to create private dns zone after ASEv3 had been created. Only available for internal load balancing mode ASE.</p>
</li>
<li><p><code>internal_load_balancing_mode</code> - (Required) Specifies which endpoints to serve internally in the Virtual Network for the App Service Environment. Possible values are <code>None</code> (for an External VIP Type), and <code>&quot;Web, Publishing&quot;</code> (for an Internal VIP Type). Defaults to <code>None</code>.</p>
</li>
<li><p><code>network_security_group_name</code> - (Optional) The network security group name of the subnet where App Service Environment exists.</p>
</li>
<li><p><code>network_security_group_security_rules</code> - (Optional) The network security group rules of the subnet network security group where App Service Environment exists.</p>
</li>
</ul>
<p>~&gt; <strong>NOTE</strong> a /24 or larger CIDR is required. Once associated with an ASE, this size cannot be changed.</p>
<p>~&gt; <strong>NOTE:</strong> This Subnet requires a delegation to <code>Microsoft.Web/hostingEnvironments</code> as detailed in the example above.    </p>
<hr>
<h2 id="Attribute-Reference"><a href="#Attribute-Reference" class="headerlink" title="Attribute Reference"></a>Attribute Reference</h2><ul>
<li><p><code>allow_new_private_endpoint_connections</code> - New Private Endpoint Connections be allowed. Defaults to <code>true</code>.</p>
</li>
<li><p><code>dns_suffix</code> - the DNS suffix for this App Service Environment V3. </p>
</li>
<li><p><code>external_inbound_ip_addresses</code> - The external outbound IP addresses of the App Service Environment V3.</p>
</li>
<li><p><code>id</code> - The ID of the App Service Environment.</p>
</li>
<li><p><code>inbound_network_dependencies</code> - An inbound Network Dependencies block as defined below.</p>
</li>
<li><p><code>internal_inbound_ip_addresses</code> - The internal outbound IP addresses of the App Service Environment V3.</p>
</li>
<li><p><code>internal_load_balancing_mode</code> - Endpoints to serve internally in the Virtual Network for the App Service Environment. Possible values are <code>None</code> (for an External VIP Type), and <code>&quot;Web, Publishing&quot;</code> (for an Internal VIP Type). Defaults to <code>None</code>.</p>
</li>
<li><p><code>ip_ssl_address_count</code> - The number of IP SSL addresses reserved for the App Service Environment V3.</p>
</li>
<li><p><code>linux_outbound_ip_addresses</code> - Outbound addresses of Linux based Apps in this App Service Environment V3</p>
</li>
<li><p><code>location</code> - The location where the App Service Environment exists.</p>
</li>
<li><p><code>name</code> - The name of the App Service Environment V3.</p>
</li>
<li><p><code>pricing_tier</code> - Pricing tier for the front end instances.</p>
</li>
<li><p><code>resource_group_name</code> - The name of the Resource Group where the App Service Environment exists.</p>
</li>
<li><p><code>subnet_id</code> - The ID of the Subnet which the App Service Environment connected.</p>
</li>
<li><p><code>windows_outbound_ip_addresses</code> - Outbound addresses of Windows based Apps in this App Service Environment V3. </p>
</li>
<li><p><code>zone_redundant</code> - ASEv3 deployed in availability zones or not.</p>
</li>
</ul>
<h2 id="Example-Usage-Internal-load-balance-ASEv3"><a href="#Example-Usage-Internal-load-balance-ASEv3" class="headerlink" title="Example Usage - Internal load balance ASEv3"></a>Example Usage - Internal load balance ASEv3</h2><p>To create an ASEv3 ILB environment, you can edit the <code>internal_load_balancing_mode</code>=<code>&quot;Web, Publishing&quot;</code>, <code>dedicated_host_count</code> and <code>zone_redundant</code> variables in the <em>terraform.tfvars</em> file.</p>
<h3 id="Edit-the-variable-file"><a href="#Edit-the-variable-file" class="headerlink" title="Edit the variable file"></a>Edit the variable file</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># terraform.tfvars</span></span><br><span class="line"><span class="string">ase_resource_group_name</span>               <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-ilb-demo&quot;</span></span><br><span class="line"><span class="string">use_existing_vnet_and_subnet</span>          <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">vnet_resource_group_name</span>              <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-demo&quot;</span></span><br><span class="line"><span class="string">virtual_network_name</span>                  <span class="string">=</span> <span class="string">&quot;vnet-spoke-asev3&quot;</span></span><br><span class="line"><span class="string">location</span>                              <span class="string">=</span> <span class="string">&quot;West US 2&quot;</span></span><br><span class="line"><span class="string">vnet_address_prefixes</span>                 <span class="string">=</span> [<span class="string">&quot;172.16.0.0/16&quot;</span>]</span><br><span class="line"><span class="string">subnet_name</span>                           <span class="string">=</span> <span class="string">&quot;snet-asev3&quot;</span></span><br><span class="line"><span class="string">subnet_address_prefixes</span>               <span class="string">=</span> [<span class="string">&quot;172.16.0.0/24&quot;</span>]</span><br><span class="line"><span class="string">ase_name</span>                              <span class="string">=</span> <span class="string">&quot;asev3-20211005&quot;</span></span><br><span class="line"><span class="string">dedicated_host_count</span>                  <span class="string">=</span> <span class="number">0</span></span><br><span class="line"><span class="string">zone_redundant</span>                        <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">create_private_dns</span>                    <span class="string">=</span> <span class="literal">true</span></span><br><span class="line"><span class="string">internal_load_balancing_mode</span>          <span class="string">=</span> <span class="string">&quot;Web, Publishing&quot;</span></span><br><span class="line"><span class="string">network_security_group_name</span>           <span class="string">=</span> <span class="string">&quot;nsg-asev3&quot;</span></span><br><span class="line"><span class="string">network_security_group_security_rules</span> <span class="string">=</span> []		</span><br></pre></td></tr></table></figure>

<h3 id="Apply-terraform"><a href="#Apply-terraform" class="headerlink" title="Apply terraform"></a>Apply terraform</h3><p>Run the following command to provision ASEv3 ILB environment.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">terraform init</span><br><span class="line"></span><br><span class="line">terraform plan</span><br><span class="line"></span><br><span class="line">terraform apply -auto-approve</span><br></pre></td></tr></table></figure>

<h2 id="Example-Usage-External-load-balance-ASEv3"><a href="#Example-Usage-External-load-balance-ASEv3" class="headerlink" title="Example Usage - External load balance ASEv3"></a>Example Usage - External load balance ASEv3</h2><p>To create an ASEv3 ELB environment, you can edit the <code>internal_load_balancing_mode</code>=<code>&quot;None&quot;</code>, <code>dedicated_host_count</code> and <code>zone_redundant</code> variables in the <em>terraform.tfvars</em> file.</p>
<h3 id="Edit-the-variable-file-1"><a href="#Edit-the-variable-file-1" class="headerlink" title="Edit the variable file"></a>Edit the variable file</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># terraform.tfvars</span></span><br><span class="line"><span class="string">ase_resource_group_name</span>               <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-ilb-demo&quot;</span></span><br><span class="line"><span class="string">use_existing_vnet_and_subnet</span>          <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">vnet_resource_group_name</span>              <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-demo&quot;</span></span><br><span class="line"><span class="string">virtual_network_name</span>                  <span class="string">=</span> <span class="string">&quot;vnet-spoke-asev3&quot;</span></span><br><span class="line"><span class="string">location</span>                              <span class="string">=</span> <span class="string">&quot;West US 2&quot;</span></span><br><span class="line"><span class="string">vnet_address_prefixes</span>                 <span class="string">=</span> [<span class="string">&quot;172.16.0.0/16&quot;</span>]</span><br><span class="line"><span class="string">subnet_name</span>                           <span class="string">=</span> <span class="string">&quot;snet-asev3&quot;</span></span><br><span class="line"><span class="string">subnet_address_prefixes</span>               <span class="string">=</span> [<span class="string">&quot;172.16.0.0/24&quot;</span>]</span><br><span class="line"><span class="string">ase_name</span>                              <span class="string">=</span> <span class="string">&quot;asev3-20211005&quot;</span></span><br><span class="line"><span class="string">dedicated_host_count</span>                  <span class="string">=</span> <span class="number">0</span></span><br><span class="line"><span class="string">zone_redundant</span>                        <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">create_private_dns</span>                    <span class="string">=</span> <span class="literal">true</span></span><br><span class="line"><span class="string">internal_load_balancing_mode</span>          <span class="string">=</span> <span class="string">&quot;None&quot;</span></span><br><span class="line"><span class="string">network_security_group_name</span>           <span class="string">=</span> <span class="string">&quot;nsg-asev3&quot;</span></span><br><span class="line"><span class="string">network_security_group_security_rules</span> <span class="string">=</span> []		</span><br></pre></td></tr></table></figure>

<h3 id="Apply-terraform-1"><a href="#Apply-terraform-1" class="headerlink" title="Apply terraform"></a>Apply terraform</h3><p>Run the following command to provision ASEv3 ELB environment.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">terraform init</span><br><span class="line"></span><br><span class="line">terraform plan</span><br><span class="line"></span><br><span class="line">terraform apply -auto-approve</span><br></pre></td></tr></table></figure>
<h2 id="Example-Usage-Internal-load-balance-ASEv3-with-AZ-support"><a href="#Example-Usage-Internal-load-balance-ASEv3-with-AZ-support" class="headerlink" title="Example Usage - Internal load balance ASEv3 with AZ support"></a>Example Usage - Internal load balance ASEv3 with AZ support</h2><p>To create an ASEv3 ILB environment with AZ support, you can edit the <code>internal_load_balancing_mode</code>=<code>&quot;Web, Publishing&quot;</code>, <code>dedicated_host_count</code> and <code>zone_redundant</code>=<code>true</code> variables in the <em>terraform.tfvars</em> file.</p>
<p>Note: You can only use either <code>dedicated_host_count</code> or <code>zone_redundant</code> attribute, you cannot use both.</p>
<h3 id="Edit-the-variable-file-2"><a href="#Edit-the-variable-file-2" class="headerlink" title="Edit the variable file"></a>Edit the variable file</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># terraform.tfvars</span></span><br><span class="line"><span class="string">ase_resource_group_name</span>               <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-ilb-demo&quot;</span></span><br><span class="line"><span class="string">use_existing_vnet_and_subnet</span>          <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">vnet_resource_group_name</span>              <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-demo&quot;</span></span><br><span class="line"><span class="string">virtual_network_name</span>                  <span class="string">=</span> <span class="string">&quot;vnet-spoke-asev3&quot;</span></span><br><span class="line"><span class="string">location</span>                              <span class="string">=</span> <span class="string">&quot;West US 2&quot;</span></span><br><span class="line"><span class="string">vnet_address_prefixes</span>                 <span class="string">=</span> [<span class="string">&quot;172.16.0.0/16&quot;</span>]</span><br><span class="line"><span class="string">subnet_name</span>                           <span class="string">=</span> <span class="string">&quot;snet-asev3&quot;</span></span><br><span class="line"><span class="string">subnet_address_prefixes</span>               <span class="string">=</span> [<span class="string">&quot;172.16.0.0/24&quot;</span>]</span><br><span class="line"><span class="string">ase_name</span>                              <span class="string">=</span> <span class="string">&quot;asev3-20211005&quot;</span></span><br><span class="line"><span class="string">dedicated_host_count</span>                  <span class="string">=</span> <span class="number">0</span></span><br><span class="line"><span class="string">zone_redundant</span>                        <span class="string">=</span> <span class="literal">true</span></span><br><span class="line"><span class="string">create_private_dns</span>                    <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">internal_load_balancing_mode</span>          <span class="string">=</span> <span class="string">&quot;Web, Publishing&quot;</span></span><br><span class="line"><span class="string">network_security_group_name</span>           <span class="string">=</span> <span class="string">&quot;nsg-asev3&quot;</span></span><br><span class="line"><span class="string">network_security_group_security_rules</span> <span class="string">=</span> []		</span><br></pre></td></tr></table></figure>

<h3 id="Apply-terraform-2"><a href="#Apply-terraform-2" class="headerlink" title="Apply terraform"></a>Apply terraform</h3><p>Run the following command to provision ASEv3 ILB with AZ support environment.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">terraform init</span><br><span class="line"></span><br><span class="line">terraform plan</span><br><span class="line"></span><br><span class="line">terraform apply -auto-approve</span><br></pre></td></tr></table></figure>
<h2 id="Example-Usage-External-load-balance-ASEv3-with-AZ-support"><a href="#Example-Usage-External-load-balance-ASEv3-with-AZ-support" class="headerlink" title="Example Usage - External load balance ASEv3 with AZ support"></a>Example Usage - External load balance ASEv3 with AZ support</h2><p>To create an ASEv3 ELB environment with AZ support, you can edit the <code>internal_load_balancing_mode</code>=<code>&quot;None&quot;</code>, <code>dedicated_host_count</code> and <code>zone_redundant</code>=<code>true</code> variables in the <em>terraform.tfvars</em> file.</p>
<p>Note: You can only use either <code>dedicated_host_count</code> or <code>zone_redundant</code> attribute, you cannot use both.</p>
<h3 id="Edit-the-variable-file-3"><a href="#Edit-the-variable-file-3" class="headerlink" title="Edit the variable file"></a>Edit the variable file</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># terraform.tfvars</span></span><br><span class="line"><span class="string">ase_resource_group_name</span>               <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-ilb-demo&quot;</span></span><br><span class="line"><span class="string">use_existing_vnet_and_subnet</span>          <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">vnet_resource_group_name</span>              <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-demo&quot;</span></span><br><span class="line"><span class="string">virtual_network_name</span>                  <span class="string">=</span> <span class="string">&quot;vnet-spoke-asev3&quot;</span></span><br><span class="line"><span class="string">location</span>                              <span class="string">=</span> <span class="string">&quot;West US 2&quot;</span></span><br><span class="line"><span class="string">vnet_address_prefixes</span>                 <span class="string">=</span> [<span class="string">&quot;172.16.0.0/16&quot;</span>]</span><br><span class="line"><span class="string">subnet_name</span>                           <span class="string">=</span> <span class="string">&quot;snet-asev3&quot;</span></span><br><span class="line"><span class="string">subnet_address_prefixes</span>               <span class="string">=</span> [<span class="string">&quot;172.16.0.0/24&quot;</span>]</span><br><span class="line"><span class="string">ase_name</span>                              <span class="string">=</span> <span class="string">&quot;asev3-20211005&quot;</span></span><br><span class="line"><span class="string">dedicated_host_count</span>                  <span class="string">=</span> <span class="number">0</span></span><br><span class="line"><span class="string">zone_redundant</span>                        <span class="string">=</span> <span class="literal">true</span></span><br><span class="line"><span class="string">create_private_dns</span>                    <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">internal_load_balancing_mode</span>          <span class="string">=</span> <span class="string">&quot;None&quot;</span></span><br><span class="line"><span class="string">network_security_group_name</span>           <span class="string">=</span> <span class="string">&quot;nsg-asev3&quot;</span></span><br><span class="line"><span class="string">network_security_group_security_rules</span> <span class="string">=</span> []		</span><br></pre></td></tr></table></figure>

<h3 id="Apply-terraform-3"><a href="#Apply-terraform-3" class="headerlink" title="Apply terraform"></a>Apply terraform</h3><p>Run the following command to provision ASEv3 ELB with AZ support environment.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">terraform init</span><br><span class="line"></span><br><span class="line">terraform plan</span><br><span class="line"></span><br><span class="line">terraform apply -auto-approve</span><br></pre></td></tr></table></figure>
<h2 id="Example-Usage-Internal-load-balance-ASEv3-on-dedicated-hosts"><a href="#Example-Usage-Internal-load-balance-ASEv3-on-dedicated-hosts" class="headerlink" title="Example Usage - Internal load balance ASEv3 on dedicated hosts"></a>Example Usage - Internal load balance ASEv3 on dedicated hosts</h2><p>To create an ASEv3 ILB environment on dedicated hosts, you can edit the <code>internal_load_balancing_mode</code>=<code>&quot;Web, Publishing&quot;</code>, <code>dedicated_host_count=2</code> and <code>zone_redundant</code> variables in the <em>terraform.tfvars</em> file.</p>
<p>Note: You can only use either <code>dedicated_host_count</code> or <code>zone_redundant</code> attribute, you cannot use both.</p>
<h3 id="Edit-the-variable-file-4"><a href="#Edit-the-variable-file-4" class="headerlink" title="Edit the variable file"></a>Edit the variable file</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># terraform.tfvars</span></span><br><span class="line"><span class="string">ase_resource_group_name</span>               <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-ilb-demo&quot;</span></span><br><span class="line"><span class="string">use_existing_vnet_and_subnet</span>          <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">vnet_resource_group_name</span>              <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-demo&quot;</span></span><br><span class="line"><span class="string">virtual_network_name</span>                  <span class="string">=</span> <span class="string">&quot;vnet-spoke-asev3&quot;</span></span><br><span class="line"><span class="string">location</span>                              <span class="string">=</span> <span class="string">&quot;West US 2&quot;</span></span><br><span class="line"><span class="string">vnet_address_prefixes</span>                 <span class="string">=</span> [<span class="string">&quot;172.16.0.0/16&quot;</span>]</span><br><span class="line"><span class="string">subnet_name</span>                           <span class="string">=</span> <span class="string">&quot;snet-asev3&quot;</span></span><br><span class="line"><span class="string">subnet_address_prefixes</span>               <span class="string">=</span> [<span class="string">&quot;172.16.0.0/24&quot;</span>]</span><br><span class="line"><span class="string">ase_name</span>                              <span class="string">=</span> <span class="string">&quot;asev3-20211005&quot;</span></span><br><span class="line"><span class="string">dedicated_host_count</span>                  <span class="string">=</span> <span class="number">2</span></span><br><span class="line"><span class="string">zone_redundant</span>                        <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">create_private_dns</span>                    <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">internal_load_balancing_mode</span>          <span class="string">=</span> <span class="string">&quot;Web, Publishing&quot;</span></span><br><span class="line"><span class="string">network_security_group_name</span>           <span class="string">=</span> <span class="string">&quot;nsg-asev3&quot;</span></span><br><span class="line"><span class="string">network_security_group_security_rules</span> <span class="string">=</span> []		</span><br></pre></td></tr></table></figure>

<h3 id="Apply-terraform-4"><a href="#Apply-terraform-4" class="headerlink" title="Apply terraform"></a>Apply terraform</h3><p>Run the following command to provision ASEv3 ILB environment.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">terraform init</span><br><span class="line"></span><br><span class="line">terraform plan</span><br><span class="line"></span><br><span class="line">terraform apply -auto-approve</span><br></pre></td></tr></table></figure>
<h2 id="Example-Usage-External-load-balance-ASEv3-on-dedicated-hosts"><a href="#Example-Usage-External-load-balance-ASEv3-on-dedicated-hosts" class="headerlink" title="Example Usage - External load balance ASEv3 on dedicated hosts"></a>Example Usage - External load balance ASEv3 on dedicated hosts</h2><p>To create an ASEv3 ELB environment on dedicated hosts, you can edit the <code>internal_load_balancing_mode</code>=<code>&quot;None&quot;</code>, <code>dedicated_host_count=2</code> and <code>zone_redundant</code> variables in the <em>terraform.tfvars</em> file.</p>
<p>Note: You can only use either <code>dedicated_host_count</code> or <code>zone_redundant</code> attribute, you cannot use both.</p>
<h3 id="Edit-the-variable-file-5"><a href="#Edit-the-variable-file-5" class="headerlink" title="Edit the variable file"></a>Edit the variable file</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># terraform.tfvars</span></span><br><span class="line"><span class="string">ase_resource_group_name</span>               <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-ilb-demo&quot;</span></span><br><span class="line"><span class="string">use_existing_vnet_and_subnet</span>          <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">vnet_resource_group_name</span>              <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-demo&quot;</span></span><br><span class="line"><span class="string">virtual_network_name</span>                  <span class="string">=</span> <span class="string">&quot;vnet-spoke-asev3&quot;</span></span><br><span class="line"><span class="string">location</span>                              <span class="string">=</span> <span class="string">&quot;West US 2&quot;</span></span><br><span class="line"><span class="string">vnet_address_prefixes</span>                 <span class="string">=</span> [<span class="string">&quot;172.16.0.0/16&quot;</span>]</span><br><span class="line"><span class="string">subnet_name</span>                           <span class="string">=</span> <span class="string">&quot;snet-asev3&quot;</span></span><br><span class="line"><span class="string">subnet_address_prefixes</span>               <span class="string">=</span> [<span class="string">&quot;172.16.0.0/24&quot;</span>]</span><br><span class="line"><span class="string">ase_name</span>                              <span class="string">=</span> <span class="string">&quot;asev3-20211005&quot;</span></span><br><span class="line"><span class="string">dedicated_host_count</span>                  <span class="string">=</span> <span class="number">2</span></span><br><span class="line"><span class="string">zone_redundant</span>                        <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">create_private_dns</span>                    <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">internal_load_balancing_mode</span>          <span class="string">=</span> <span class="string">&quot;None&quot;</span></span><br><span class="line"><span class="string">network_security_group_name</span>           <span class="string">=</span> <span class="string">&quot;nsg-asev3&quot;</span></span><br><span class="line"><span class="string">network_security_group_security_rules</span> <span class="string">=</span> []		</span><br></pre></td></tr></table></figure>

<h3 id="Apply-terraform-5"><a href="#Apply-terraform-5" class="headerlink" title="Apply terraform"></a>Apply terraform</h3><p>Run the following command to provision ASEv3 ILB environment.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">terraform init</span><br><span class="line"></span><br><span class="line">terraform plan</span><br><span class="line"></span><br><span class="line">terraform apply -auto-approve</span><br></pre></td></tr></table></figure>

<h2 id="Example-Usage-Internal-load-balance-ASEv3-on-an-existing-VNet-and-subnet"><a href="#Example-Usage-Internal-load-balance-ASEv3-on-an-existing-VNet-and-subnet" class="headerlink" title="Example Usage - Internal load balance ASEv3 on an existing VNet and subnet"></a>Example Usage - Internal load balance ASEv3 on an existing VNet and subnet</h2><p>To create an ASEv3 ILB environment on an existing VNet and subnet, you can edit the <code>use_existing_vnet_and_subnet</code>=<code>true</code>, <code>vnet_resource_group_name</code>,<code>virtual_network_name</code> and <code>subnet_name</code> variables in the <em>terraform.tfvars</em> file.</p>
<h3 id="Edit-the-variable-file-6"><a href="#Edit-the-variable-file-6" class="headerlink" title="Edit the variable file"></a>Edit the variable file</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># terraform.tfvars</span></span><br><span class="line"><span class="string">ase_resource_group_name</span>               <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-ilb-demo&quot;</span></span><br><span class="line"><span class="string">use_existing_vnet_and_subnet</span>          <span class="string">=</span> <span class="literal">true</span></span><br><span class="line"><span class="string">vnet_resource_group_name</span>              <span class="string">=</span> <span class="string">&quot;rg-asev3-terraform-demo&quot;</span></span><br><span class="line"><span class="string">virtual_network_name</span>                  <span class="string">=</span> <span class="string">&quot;vnet-spoke-asev3&quot;</span></span><br><span class="line"><span class="string">location</span>                              <span class="string">=</span> <span class="string">&quot;West US 2&quot;</span></span><br><span class="line"><span class="string">vnet_address_prefixes</span>                 <span class="string">=</span> [<span class="string">&quot;172.16.0.0/16&quot;</span>]</span><br><span class="line"><span class="string">subnet_name</span>                           <span class="string">=</span> <span class="string">&quot;snet-asev3&quot;</span></span><br><span class="line"><span class="string">subnet_address_prefixes</span>               <span class="string">=</span> [<span class="string">&quot;172.16.0.0/24&quot;</span>]</span><br><span class="line"><span class="string">ase_name</span>                              <span class="string">=</span> <span class="string">&quot;asev3-20211005&quot;</span></span><br><span class="line"><span class="string">dedicated_host_count</span>                  <span class="string">=</span> <span class="number">0</span></span><br><span class="line"><span class="string">zone_redundant</span>                        <span class="string">=</span> <span class="literal">false</span></span><br><span class="line"><span class="string">create_private_dns</span>                    <span class="string">=</span> <span class="literal">true</span></span><br><span class="line"><span class="string">internal_load_balancing_mode</span>          <span class="string">=</span> <span class="string">&quot;Web, Publishing&quot;</span></span><br><span class="line"><span class="string">network_security_group_name</span>           <span class="string">=</span> <span class="string">&quot;nsg-asev3&quot;</span></span><br><span class="line"><span class="string">network_security_group_security_rules</span> <span class="string">=</span> []		</span><br></pre></td></tr></table></figure>
<h3 id="Import-the-subnet-status-to-terraform"><a href="#Import-the-subnet-status-to-terraform" class="headerlink" title="Import the subnet status to terraform"></a>Import the subnet status to terraform</h3><p>When using the existing subnet, it is required to delegate subnet to <strong>Microsoft.Web/hostingEnvironments</strong>. To do the delegation on subnet, you will need to import the status to terraform by following command before apply the terraform plan: (where <code>snet-delegation</code> is the delegation subnet defined in your terraform template)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform import azurerm_subnet.snet-delegation /subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/yourvnetresourcegroup/providers/Microsoft.Network/virtualNetworks/yourventname/subnets/yoursubnetname</span><br></pre></td></tr></table></figure>

<h3 id="Apply-terraform-6"><a href="#Apply-terraform-6" class="headerlink" title="Apply terraform"></a>Apply terraform</h3><p>Run the following command to provision ASEv3 ILB environment.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">terraform init</span><br><span class="line"></span><br><span class="line">terraform plan</span><br><span class="line"></span><br><span class="line">terraform apply -auto-approve</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://blog.samtreepay.com/2021/10/01/create-an-asev3-from-arm-templates/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avator.png">
      <meta itemprop="name" content="Sam Lin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雜七雜八。有的沒的">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/01/create-an-asev3-from-arm-templates/" class="post-title-link" itemprop="url">Create an ASEv3 from ARM templates</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-10-01 00:30:56" itemprop="dateCreated datePublished" datetime="2021-10-01T00:30:56+08:00">2021-10-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-10-05 02:48:14" itemprop="dateModified" datetime="2021-10-05T02:48:14+08:00">2021-10-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/App-Service-Environment/" itemprop="url" rel="index"><span itemprop="name">App Service Environment</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2021/10/01/create-an-asev3-from-arm-templates/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/10/01/create-an-asev3-from-arm-templates/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>Azure App Service environments (ASEs) can be created with an internet-accessible endpoint or an endpoint on an internal address in an Azure virtual network (VNet). When created with an internal endpoint, that endpoint is provided by an Azure component called an internal load balancer (ILB). The ASE on an internal IP address is called an ILB ASE. The ASE with a public endpoint is called an External ASE. </p>
<p>An ASE can be created by using the Azure portal or an Azure Resource Manager template. This article walks through the steps and syntax you need to create an External ASE or ILB ASE with templates. To learn how to create an ASEv3 in the Azure portal, see <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/app-service/environment/creation">Create an App Service Environment - Azure App Service Environment</a>.</p>
<p>When you create an ASEv3 in the Azure portal, you can create your VNet at the same time or choose a preexisting VNet to deploy into. When you create an ASE from a template, you must start with: </p>
<ul>
<li>A Resource Manager VNet.</li>
<li>A subnetin that VNet. We recommend an ASE subnetsize of <code>/24</code> with 256 addresses to accommodate future growth and scaling needs. After the ASE is created, you can’t change the size.</li>
<li>The resource group of your VNet. You can get this information from the Azure portal under your virtual network properties.</li>
<li>The subscription you want to deploy into.</li>
<li>The location you want to deploy into.</li>
</ul>
<p>To automate your ASEv3 creation:</p>
<ol>
<li><p>Create the ASEv3 from a template.</p>
</li>
<li><p>After your ILB ASEv3 is created, an private DNS zone will be created if you set <em>createPrivateDNS</em> parameter to true.</p>
</li>
</ol>
<h2 id="Create-the-ASEv3"><a href="#Create-the-ASEv3" class="headerlink" title="Create the ASEv3"></a>Create the ASEv3</h2><p>A Resource Manager template that creates an ASE and its associated parameters file is available <a target="_blank" rel="noopener" href="https://azure.microsoft.com/en-us/resources/templates/web-app-asp-app-on-asev3-create/">in an example</a> on GitHub.</p>
<p>If you want to make an ASEv3, use these Resource Manager template <a target="_blank" rel="noopener" href="https://github.com/Azure/azure-quickstart-templates/tree/master/quickstarts/microsoft.web/web-app-asp-app-on-asev3-create">example</a>. They cater to that use case. Most of the parameters in the <em>azuredeploy.parameters.json</em> file are common to the creation of ILB ASEs and External ASEs. The following list calls out parameters of special note, or that are unique, when you create an ILB ASE with an existing subnet:</p>
<ul>
<li><em>aseName</em>: Required. This parameter defines an unique ASE name. </li>
<li><em>internalLoadBalancingMode</em>: Required. In most cases, set this to 3, which means both HTTP/HTTPS traffic on ports 80/443, and the control/data channel ports listened to by the FTP service on the ASE, will be bound to an ILB-allocated virtual network internal address. If this property is set to 2, only the FTP service-related ports (both control and data channels) are bound to an ILB address. The HTTP/HTTPS traffic remains on the public VIP.</li>
<li><em>zoneRedundant</em>: Required. In most cases, set this to false, which means the ASE will not be deployed into Availability Zones(AZ). Zonal ASEs can be deployed in some regions, you can refer to <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/app-service/environment/zone-redundancy">this</a>.</li>
<li><em>dedicatedHostCount</em>: Required. In most cases, set this to 0, which means the ASE will be deployed as normal without dedicated hosts deployed.</li>
<li><em>useExistingVnetandSubnet</em>: Required. Set to true if using an existing VNet and subnet. </li>
<li><em>vNetResourceGroupName</em>: Required if an using existing VNET and Subnet. This parameter defines the resource group name of the existing VNet and subnet where ASE will reside.</li>
<li><em>virtualNetworkName</em>: Required if using an existing VNet and Subnet. This parameter defines the virtual network name of the existing VNet and subnet where ASE will reside.</li>
<li><em>subnetName</em>: Required if using an existing VNet and Subnet. This parameter defines the subnet name of the existing VNet and subnet where ASE will reside.</li>
<li><em>createPrivateDNS</em>: Set to true if you want to create a private DNS zone after ASEv3 created. For an ILB ASE, when set this parameter to true, it will create a private DNS zone as ASE name with <em>appserviceenvironment.net</em> DNS suffix. </li>
</ul>
<p>After the <em>azuredeploy.parameters.json</em> file is filled in, create the ASE by using the PowerShell code snippet. Change the file paths to match the Resource Manager template-file locations on your machine. Remember to supply your own values for the Resource Manager deployment name and the resource group name:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$templatePath</span>=<span class="string">&quot;PATH\azuredeploy.json&quot;</span></span><br><span class="line"><span class="variable">$parameterPath</span>=<span class="string">&quot;PATH\azuredeploy.parameters.json&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">New-AzResourceGroupDeployment</span> <span class="literal">-Name</span> <span class="string">&quot;CHANGEME&quot;</span> <span class="literal">-ResourceGroupName</span> <span class="string">&quot;YOUR-RG-NAME-HERE&quot;</span> <span class="literal">-TemplateFile</span> <span class="variable">$templatePath</span> <span class="literal">-TemplateParameterFile</span> <span class="variable">$parameterPath</span></span><br></pre></td></tr></table></figure>

<p>It takes about two hours for the ASEv3 to be created. Then the ASEv3 shows up in the portal in the list of ASEs for the subscription that triggered the deployment.</p>
<hr>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/app-service/environment/create-from-template">Create an ASE with ARM - Azure App Service Environment</a></li>
<li><a target="_blank" rel="noopener" href="https://azure.microsoft.com/en-us/resources/templates/web-app-asp-app-on-asev3-create/">Create an AppServicePlan and App in an ASEv3</a></li>
<li>[Availability Zone support for App Service Environments - Azure App Service Environment](</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Sam Lin"
      src="/images/avator.png">
  <p class="site-author-name" itemprop="name">Sam Lin</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">2</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/samlin-msft" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;samlin-msft" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.linkedin.com/in/samlintw" title="Linkedin → https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;samlintw" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sam Lin</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://samlin-msft-blog.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
